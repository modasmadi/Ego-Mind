<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#050510">
    <link rel="manifest" href="manifest.json">
    <title>The Million Logo Page - First Arabic Digital Advertising Museum</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800;900&family=Poppins:wght@400;500;600;700;800;900&display=swap"
        rel="stylesheet">

    <!-- AR Support -->
    <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').catch(err => console.log('SW registration failed:', err));
            });
        }
    </script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>

    <!-- PayPal SDK (LIVE) -->
    <script
        src="https://www.paypal.com/sdk/js?client-id=BAAk9yw3Q3kBrhAz43W_k90Q4gqpHJlRW3ZFxoL9mIzAY9Y87WhUzmk3kf0OqpvjvmEtzQ7i5vwyApMRvA&currency=USD"></script>

    <style>
        :root {
            --font-en: 'Poppins', sans-serif;
            --font-ar: 'Tajawal', sans-serif;
            --primary: #8b5cf6;
            --primary-light: #a78bfa;
            --secondary: #ec4899;
            --dark: #050510;
            /* Deeper midnight black */
            --dark-light: #0d0d1a;
            --dark-card: #0f0f24;
            /* Solid, deep surface */
            --neon-glow: 0 0 20px rgba(139, 92, 246, 0.4);
            --neon-green: #10b981;
            --neon-pink: #ec4899;
        }

        body {
            font-family: var(--font-en);
            background: var(--dark);
            color: #fff;
            touch-action: pan-x pan-y;
            /* Prevent pinch zoom but allow scrolling */
            user-select: none;
            -webkit-user-select: none;
            overflow-x: hidden;
            width: 100vw;
            position: relative;
            /* Fix mobile dimensions */
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        body[dir="rtl"] {
            font-family: var(--font-ar);
        }

        html {
            scroll-behavior: smooth;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--dark);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 4px;
        }

        /* Ticker Animation */
        .ticker-container {
            background: rgba(139, 92, 246, 0.05);
            border-top: 1px solid rgba(139, 92, 246, 0.1);
            border-bottom: 1px solid rgba(139, 92, 246, 0.1);
            overflow: hidden;
            white-space: nowrap;
            padding: 12px 0;
            user-select: none;
            position: relative;
            z-index: 10;
        }

        .ticker-content {
            display: inline-block;
            white-space: nowrap;
            animation: ticker 40s linear infinite;
        }

        @keyframes ticker {
            0% {
                transform: translateX(0);
            }

            100% {
                transform: translateX(-50%);
            }
        }

        .ticker-item {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 0 50px;
            color: #a78bfa;
            font-size: 0.85rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        /* Mobile Fixes - Force Fixed Dimensions */
        nav {
            height: 72px;
        }

        .hero-bg {
            padding-top: 80px;
        }

        #canvasContainer {
            overflow: hidden;
            touch-action: none;
        }

        /* Grid Cells - Optimized */
        .grid-cell {
            width: 10px;
            height: 10px;
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
            border-radius: 2px;
        }

        .grid-cell:hover {
            transform: scale(3);
            z-index: 100;
            box-shadow: 0 0 20px rgba(139, 92, 246, 0.5);
        }

        .grid-cell.sold {
            background-size: cover;
            background-position: center;
        }

        .grid-cell.available {
            background: linear-gradient(135deg, #1e1e3f 0%, #2a2a4a 100%);
            border: 1px solid rgba(139, 92, 246, 0.1);
        }

        .grid-cell.available:hover {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
        }

        .gradient-text {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .gradient-border {
            position: relative;
            background: var(--dark-card);
            border-radius: 1rem;
        }

        .gradient-border::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 1rem;
            padding: 1px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
        }

        .glow-btn {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            box-shadow: 0 0 20px rgba(139, 92, 246, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.5s cubic-bezier(0.19, 1, 0.22, 1);
        }

        .glow-btn:hover {
            box-shadow: 0 0 40px rgba(139, 92, 246, 0.6);
            transform: translateY(-2px) scale(1.02);
        }

        .glass-card {
            background: var(--dark-card);
            border: 1px solid rgba(139, 92, 246, 0.15);
            border-radius: 1.5rem;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
            transition: all 0.5s cubic-bezier(0.19, 1, 0.22, 1);
        }

        .glass-card:hover {
            border-color: rgba(139, 92, 246, 0.4);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5), var(--neon-glow);
        }

        .hero-bg {
            background:
                radial-gradient(circle at 50% -20%, rgba(139, 92, 246, 0.15), transparent 60%),
                var(--dark);
        }

        .upload-zone {
            border: 2px dashed rgba(139, 92, 246, 0.3);
            transition: all 0.3s ease;
            cursor: pointer;
            border-radius: 1rem;
        }

        .upload-zone:hover {
            border-color: var(--primary);
        }

        .upload-zone.has-image {
            border-color: #10b981;
        }

        .loading-spinner {
            border: 3px solid rgba(139, 92, 246, 0.2);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .step-badge {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
        }

        .founder-card {
            background: var(--dark-card);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 1.5rem;
            padding: 1.5rem;
            text-align: center;
            transition: all 0.5s cubic-bezier(0.19, 1, 0.22, 1);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .founder-card:hover {
            border-color: var(--primary);
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5), 0 0 20px rgba(139, 92, 246, 0.2);
        }

        .founder-avatar {
            width: 90px;
            height: 90px;
            border-radius: 50%;
            object-fit: cover;
            margin: 0 auto;
            border: 3px solid var(--dark);
            box-shadow: 0 0 15px rgba(139, 92, 246, 0.3);
        }

        .founder-rank {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .founder-rank.gold {
            background: rgba(234, 179, 8, 0.1);
            color: #fbbf24;
            border: 1px solid rgba(234, 179, 8, 0.2);
        }

        .founder-rank.silver {
            background: rgba(156, 163, 175, 0.1);
            color: #9ca3af;
            border: 1px solid rgba(156, 163, 175, 0.2);
        }

        .founder-rank.bronze {
            background: rgba(180, 83, 9, 0.1);
            color: #d97706;
            border: 1px solid rgba(180, 83, 9, 0.2);
        }

        .stat-card {
            background: var(--dark-card);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 1.5rem;
            padding: 2rem;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            transition: all 0.6s cubic-bezier(0.19, 1, 0.22, 1);
            position: relative;
            overflow: hidden;
        }

        .stat-card.primary {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1) 0%, rgba(236, 72, 153, 0.1) 100%), var(--dark-card);
            border-color: rgba(139, 92, 246, 0.3);
            box-shadow: 0 0 30px rgba(139, 92, 246, 0.15);
        }

        .stat-card::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.03), transparent);
            transform: rotate(45deg);
            transition: 0.8s;
            pointer-events: none;
        }

        .stat-card:hover::after {
            left: 100%;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            border-color: rgba(255, 255, 255, 0.2);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5), 0 0 20px rgba(255, 255, 255, 0.05);
        }

        .glow-text {
            text-shadow: 0 0 15px currentColor;
        }

        @keyframes cardEntrance {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .stat-card {
            animation: cardEntrance 0.8s ease backwards;
        }

        .stat-card:nth-child(2) {
            animation-delay: 0.1s;
        }

        .stat-card:nth-child(3) {
            animation-delay: 0.2s;
        }

        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .modal-overlay {
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
        }

        .charter-card {
            background: var(--dark-card);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 1.5rem;
            padding: 2rem;
            text-align: center;
            transition: all 0.5s cubic-bezier(0.19, 1, 0.22, 1);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .charter-card:hover {
            border-color: var(--secondary);
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(236, 72, 153, 0.1);
        }

        /* Welcome Banner */
        .welcome-banner {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1) 0%, rgba(236, 72, 153, 0.1) 100%);
            border: 1px solid rgba(139, 92, 246, 0.2);
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* FAQ Accordion */
        .faq-item {
            background: var(--dark-card);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 1.25rem;
            overflow: hidden;
            transition: all 0.5s cubic-bezier(0.19, 1, 0.22, 1);
            margin-bottom: 1rem;
        }

        .faq-item:hover {
            border-color: rgba(139, 92, 246, 0.3);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .faq-question {
            cursor: pointer;
            padding: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #e5e7eb;
            font-weight: 600;
        }

        .faq-answer {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .faq-item.open .faq-answer {
            max-height: 200px;
        }

        .faq-item.open .faq-icon {
            transform: rotate(180deg);
        }

        .faq-icon {
            transition: transform 0.3s ease;
        }

        /* Search Box */
        .search-box {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: 0.75rem;
            transition: all 0.3s ease;
        }

        .search-box:focus-within {
            border-color: var(--primary);
            background: rgba(255, 255, 255, 0.1);
        }

        /* Canvas Grid */
        .canvas-container {
            position: relative;
            width: 100%;
            overflow: hidden;
            border-radius: 1rem;
            background: rgba(26, 26, 46, 0.8);
            border: 1px solid rgba(139, 92, 246, 0.1);
        }

        #gridCanvas {
            cursor: crosshair;
            display: block;
        }

        .canvas-controls {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .canvas-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(139, 92, 246, 0.2);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
        }

        .canvas-btn:hover {
            background: rgba(139, 92, 246, 0.2);
            border-color: var(--primary);
        }

        .canvas-btn.active {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-color: var(--primary);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                box-shadow: 0 0 0 0 rgba(139, 92, 246, 0.4);
            }

            50% {
                box-shadow: 0 0 0 8px rgba(139, 92, 246, 0);
            }
        }

        .select-mode-btn {
            min-width: 80px;
        }

        .canvas-info {
            text-align: center;
            color: #9ca3af;
            font-size: 0.75rem;
            margin-top: 0.5rem;
        }

        .zoom-display {
            background: rgba(139, 92, 246, 0.2);
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            color: var(--primary-light);
        }

        .coordinates-display {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.7rem;
            color: #9ca3af;
            pointer-events: none;
        }

        .cell-tooltip {
            position: absolute;
            background: rgba(22, 22, 42, 0.98);
            border: 1px solid rgba(139, 92, 246, 0.4);
            border-radius: 1rem;
            padding: 1rem;
            pointer-events: none;
            z-index: 1000;
            max-width: 260px;
            min-width: 200px;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.6), 0 0 20px rgba(139, 92, 246, 0.2);
            backdrop-filter: blur(10px);
            animation: tooltipFade 0.2s ease;
        }

        @keyframes tooltipFade {
            from {
                opacity: 0;
                transform: translateY(5px) scale(0.95);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .cell-tooltip img {
            width: 80px;
            height: 80px;
            border-radius: 0.75rem;
            object-fit: cover;
            margin: 0 auto 0.75rem;
            display: block;
            border: 2px solid rgba(139, 92, 246, 0.3);
        }

        .cell-tooltip .tooltip-name {
            font-weight: 700;
            font-size: 1rem;
            color: white;
            text-align: center;
            margin-bottom: 0.25rem;
        }

        .cell-tooltip .tooltip-cell-id {
            font-size: 0.7rem;
            color: #a78bfa;
            text-align: center;
            margin-bottom: 0.5rem;
        }

        .cell-tooltip .tooltip-date {
            font-size: 0.75rem;
            color: #f472b6;
            text-align: center;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.25rem;
        }

        .cell-tooltip .tooltip-story {
            font-size: 0.75rem;
            color: #9ca3af;
            text-align: center;
            line-height: 1.4;
            margin-bottom: 0.75rem;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .cell-tooltip .tooltip-stats {
            display: flex;
            justify-content: center;
            gap: 1rem;
            padding-top: 0.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .cell-tooltip .tooltip-stat {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.8rem;
        }

        .cell-tooltip .tooltip-stat.likes {
            color: #f472b6;
        }

        .cell-tooltip .tooltip-stat.comments {
            color: #60a5fa;
        }

        .cell-tooltip .tooltip-hint {
            font-size: 0.65rem;
            color: #6b7280;
            text-align: center;
            margin-top: 0.5rem;
        }

        .mini-map {
            position: absolute;
            bottom: 10px;
            right: 10px;
            width: 120px;
            height: 120px;
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 0.5rem;
            overflow: hidden;
        }

        .mini-map canvas {
            width: 100%;
            height: 100%;
        }

        .viewport-indicator {
            position: absolute;
            border: 2px solid var(--primary);
            background: rgba(139, 92, 246, 0.2);
            pointer-events: none;
        }

        /* Mobile Optimizations */
        * {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
        }

        input,
        textarea,
        button,
        select {
            font-size: 16px !important;
            /* Prevents zoom on iOS */
        }

        @media (max-width: 640px) {
            .hero-bg {
                min-height: auto;
                padding-top: 100px;
                padding-bottom: 30px;
            }

            nav {
                height: 70px !important;
                padding: 0 !important;
            }

            nav .max-w-7xl {
                padding: 0 12px !important;
                height: 100%;
            }

            nav button {
                padding: 8px 12px !important;
                font-size: 13px !important;
                border-radius: 10px !important;
                height: 40px !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                gap: 5px !important;
            }

            nav #langIcon {
                font-size: 16px !important;
            }

            nav #langText {
                font-size: 12px !important;
                font-weight: 800 !important;
            }

            nav .w-10.h-10 {
                width: 32px !important;
                height: 32px !important;
                font-size: 14px !important;
                border-radius: 8px !important;
            }

            .stat-card {
                padding: 1rem;
                min-width: 100px;
            }

            .stat-card .text-3xl {
                font-size: 1.5rem;
            }

            .canvas-container {
                border-radius: 0.5rem;
            }

            .mini-map {
                width: 80px;
                height: 80px;
                bottom: 5px;
                right: 5px;
            }

            .coordinates-display {
                font-size: 0.6rem;
                padding: 0.15rem 0.35rem;
            }

            .founder-card {
                padding: 1rem;
            }

            .founder-avatar {
                width: 60px;
                height: 60px;
            }

            .glass-card {
                border-radius: 0.75rem;
            }

            .modal-overlay {
                padding: 0.5rem;
            }

            /* Fix modal on mobile */
            #claimModal .glass-card,
            #viewModal .glass-card {
                max-height: 90vh;
                overflow-y: auto;
            }
        }


        /* Smooth scrolling for all elements */
        * {
            scroll-behavior: smooth;
        }

        /* Better touch feedback */
        @media (hover: none) {
            .canvas-btn:active {
                background: rgba(139, 92, 246, 0.4);
            }
        }

        /* Ticker Animation */
        @keyframes marquee {
            0% {
                transform: translateX(100%);
            }

            100% {
                transform: translateX(-100%);
            }
        }

        .animate-marquee {
            animation: marquee 30s linear infinite;
        }

        /* Shine Effect */
        .shine-card {
            position: relative;
            overflow: hidden;
        }

        .shine-card::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 50%;
            height: 100%;
            background: linear-gradient(to right,
                    transparent,
                    rgba(255, 255, 255, 0.1),
                    transparent);
            transform: skewX(-25deg);
            transition: 0.5s;
        }

        .shine-card:hover::after {
            animation: shine 1s;
        }

        @keyframes shine {
            100% {
                left: 125%;
            }
        }

        .canvas-btn:active,
        .glow-btn:active {
            transform: scale(0.95);
        }

        /* Prevent text selection on buttons */
        button,
        a {
            -webkit-user-select: none;
            user-select: none;
        }
    </style>
</head>

<body>
    <!-- Welcome Banner (for new visitors) -->
    <div id="welcomeBanner" class="hidden fixed top-16 left-4 right-4 z-40 welcome-banner rounded-xl p-4 sm:p-5">
        <div class="max-w-4xl mx-auto flex items-center justify-between gap-4">
            <div class="flex items-center gap-3">
                <span class="text-2xl">üëã</span>
                <div>
                    <p class="font-semibold text-white text-sm sm:text-base"
                        data-en="Welcome! Want to be part of history?" data-ar="ŸÖÿ±ÿ≠ÿ®ÿßŸã! ÿ™ÿ±ŸäÿØ ÿ£ŸÜ ÿ™ŸÉŸàŸÜ ÿ¨ÿ≤ÿ°ÿßŸã ŸÖŸÜ ÿßŸÑÿ™ÿßÿ±ŸäÿÆÿü">
                        Welcome! Want to be part of history?</p>
                    <p class="text-gray-400 text-xs sm:text-sm" data-en="Get your cell for just $2.00 - forever!"
                        data-ar="ÿßÿ≠ÿ¨ÿ≤ ÿÆÿßŸÜÿ™ŸÉ ÿ®ŸÄ 2 ÿØŸàŸÑÿßÿ± ŸÅŸÇÿ∑ - ŸÑŸÑÿ£ÿ®ÿØ!">Get your cell for just $2.00 - forever!</p>
                </div>
            </div>
            <button onclick="closeWelcome()" class="text-gray-400 hover:text-white text-xl">&times;</button>
        </div>
    </div>

    <!-- Navigation -->
    <nav class="fixed top-0 w-full bg-[#0f0f1a]/90 backdrop-blur-md z-50 border-b border-white/5">
        <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div
                    class="w-10 h-10 rounded-xl bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center text-xl font-bold">
                    M</div>
                <span class="text-xl font-bold hidden sm:block" data-en="Million Logo" data-ar="ÿßŸÑÿµŸÅÿ≠ÿ© ÿßŸÑŸÖŸÑŸäŸàŸÜ">Million
                    Logo</span>
            </div>
            <div class="flex items-center gap-2 sm:gap-3">
                <button onclick="toggleLanguage()"
                    class="flex items-center gap-2 bg-gradient-to-r from-purple-500/20 to-pink-500/20 hover:from-purple-500/30 hover:to-pink-500/30 px-4 sm:px-5 py-2.5 sm:py-3 rounded-xl transition-all duration-300 border border-purple-500/30 hover:border-purple-500/50 hover:scale-105 shadow-lg">
                    <span id="langIcon" class="text-2xl sm:text-3xl">üá∫üá∏</span>
                    <span id="langText" class="font-bold text-base sm:text-lg text-white">English</span>
                </button>
                <a href="#grid"
                    class="glow-btn px-4 sm:px-6 py-2 sm:py-2.5 rounded-full font-semibold text-sm sm:text-base">
                    <span data-en="Get Your Cell" data-ar="ÿßÿ≠ÿ¨ÿ≤ ÿÆÿßŸÜÿ™ŸÉ">Get Your Cell</span>
                </a>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <section class="hero-bg min-h-screen flex items-center justify-center pt-20">
        <div class="max-w-5xl mx-auto px-4 text-center">
            <div class="mb-6">
                <span
                    class="inline-block glass-card px-4 sm:px-6 py-2 sm:py-3 text-xs sm:text-sm font-medium text-purple-300">
                    üèõÔ∏è <span data-en="First Arabic Digital Advertising Museum"
                        data-ar="ÿ£ŸàŸÑ ŸÖÿ™ÿ≠ŸÅ ÿ•ÿπŸÑÿßŸÜŸä ÿ±ŸÇŸÖŸä ÿπÿ±ÿ®Ÿä">First Arabic Digital Advertising Museum</span>
                </span>
            </div>

            <h1 class="text-4xl sm:text-5xl md:text-7xl font-black mb-4 leading-tight">
                <span class="text-white" data-en="The Million" data-ar="ÿßŸÑÿµŸÅÿ≠ÿ©">The Million</span><br>
                <span class="gradient-text" data-en="Logo Page" data-ar="ÿßŸÑŸÖŸÑŸäŸàŸÜ ÿ¥ÿπÿßÿ±">Logo Page</span>
            </h1>

            <!-- ÿßŸÑÿ¨ŸÖŸÑÿ© ÿßŸÑŸÇŸàŸäÿ© ÿßŸÑŸàÿßÿ∂ÿ≠ÿ© -->
            <div
                class="bg-[#0f0f24] border-2 border-purple-500/40 rounded-3xl p-6 sm:p-8 mb-8 max-w-xl mx-auto shadow-[0_0_30px_rgba(139,92,246,0.2)] transition-all duration-500 hover:scale-[1.02]">
                <h2 class="text-xl sm:text-2xl md:text-3xl font-bold text-white mb-2">
                    <span data-en="Reserve Your Spot Forever" data-ar="ÿßÿ≠ÿ¨ÿ≤ ŸÖŸÉÿßŸÜŸÉ ŸÑŸÑÿ£ÿ®ÿØ">Reserve Your Spot
                        Forever</span>
                </h2>
                <p class="text-3xl sm:text-4xl font-black gradient-text">
                    <span data-en="Just $2.00!" data-ar="ŸÅŸÇÿ∑ 2 ÿØŸàŸÑÿßÿ±!">Just $2.00!</span>
                </p>
            </div>

            <!-- ÿ£ŸÖÿ´ŸÑÿ© ÿπŸÑŸâ ÿßŸÑÿßÿ≥ÿ™ÿÆÿØÿßŸÖÿßÿ™ -->
            <div class="flex flex-wrap justify-center gap-3 mb-10 max-w-2xl mx-auto">
                <span
                    class="bg-[#0f0f24] border border-white/10 px-4 py-2 rounded-xl text-xs sm:text-sm text-gray-300 shadow-lg">
                    üíº <span data-en="Your Company Logo" data-ar="ÿ¥ÿπÿßÿ± ÿ¥ÿ±ŸÉÿ™ŸÉ">Your Company Logo</span>
                </span>
                <span
                    class="bg-[#0f0f24] border border-white/10 px-4 py-2 rounded-xl text-xs sm:text-sm text-gray-300 shadow-lg">
                    üë§ <span data-en="Your Name" data-ar="ÿßÿ≥ŸÖŸÉ">Your Name</span>
                </span>
                <span
                    class="bg-[#0f0f24] border border-white/10 px-4 py-2 rounded-xl text-xs sm:text-sm text-gray-300 shadow-lg">
                    ‚ù§Ô∏è <span data-en="Memory of Someone" data-ar="ÿ∞ŸÉÿ±Ÿâ ÿ¥ÿÆÿµ">Memory of Someone</span>
                </span>
                <span
                    class="bg-[#0f0f24] border border-white/10 px-4 py-2 rounded-xl text-xs sm:text-sm text-gray-300 shadow-lg">
                    üéÇ <span data-en="Important Date" data-ar="ÿ™ÿßÿ±ŸäÿÆ ŸÖŸáŸÖ">Important Date</span>
                </span>
                <span
                    class="bg-[#0f0f24] border border-white/10 px-4 py-2 rounded-xl text-xs sm:text-sm text-gray-300 shadow-lg">
                    ‚≠ê <span data-en="Digital Legacy" data-ar="ÿ£ÿ´ÿ± ÿ±ŸÇŸÖŸä ÿØÿßÿ¶ŸÖ">Digital Legacy</span>
                </span>
            </div>

            <!-- Stats Grid: 3 Balanced Columns -->
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-8">
                <!-- Stat 1: Stories Shared (Purple Glow) -->
                <div
                    class="stat-card primary group relative overflow-hidden transition-all duration-500 hover:scale-[1.05]">
                    <div
                        class="absolute inset-0 bg-gradient-to-br from-purple-500/10 to-transparent opacity-0 group-hover:opacity-100 transition-opacity">
                    </div>
                    <div class="text-3xl sm:text-4xl font-black text-white glow-text" id="soldCount">0</div>
                    <div class="text-[10px] sm:text-xs text-purple-300 font-bold uppercase tracking-[0.2em] mt-1"
                        data-en="Stories Shared" data-ar="ŸÇÿµÿ© ŸÖÿ¥ÿßÿ±ŸÉÿ©">Stories Shared</div>
                    <div
                        class="absolute -bottom-1 -right-1 text-2xl opacity-10 group-hover:opacity-20 transition-opacity">
                        ‚ú®</div>
                </div>

                <!-- Stat 2: Total Invested (Green Glow) -->
                <div
                    class="stat-card border-green-500/30 bg-green-500/5 group relative overflow-hidden transition-all duration-500 hover:scale-[1.05]">
                    <div
                        class="absolute inset-0 bg-gradient-to-br from-green-500/10 to-transparent opacity-0 group-hover:opacity-100 transition-opacity">
                    </div>
                    <div class="text-3xl sm:text-4xl font-black text-green-400 flex items-center justify-center gap-1">
                        <span>$</span><span id="totalInvestment">0.00</span>
                    </div>
                    <div class="text-[10px] sm:text-xs text-green-300/70 font-bold uppercase tracking-[0.2em] mt-1"
                        data-en="Total Invested" data-ar="ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿßÿ≥ÿ™ÿ´ŸÖÿßÿ±">Total Invested</div>
                    <div
                        class="absolute -bottom-1 -right-1 text-2xl opacity-10 group-hover:opacity-20 transition-opacity">
                        üí∞</div>
                </div>

                <!-- Stat 3: Available Cells (Pink Glow) -->
                <div
                    class="stat-card border-pink-500/30 bg-pink-500/5 group relative overflow-hidden transition-all duration-500 hover:scale-[1.05]">
                    <div
                        class="absolute inset-0 bg-gradient-to-br from-pink-500/10 to-transparent opacity-0 group-hover:opacity-100 transition-opacity">
                    </div>
                    <div class="text-3xl sm:text-4xl font-black text-pink-400" id="availableCount">1,000,000</div>
                    <div class="text-[10px] sm:text-xs text-pink-300/70 font-bold uppercase tracking-[0.2em] mt-1"
                        data-en="Cells Available" data-ar="ÿÆÿßŸÜÿ© ŸÖÿ™ÿßÿ≠ÿ©">Cells Available</div>
                    <div
                        class="absolute -bottom-1 -right-1 text-2xl opacity-10 group-hover:opacity-20 transition-opacity">
                        ‚è≥</div>
                </div>
            </div>

            <!-- Progress Bar -->
            <div class="max-w-md mx-auto mb-10">
                <div class="flex justify-between text-xs text-gray-400 mb-2">
                    <span data-en="Progress" data-ar="ÿßŸÑÿ™ŸÇÿØŸÖ">Progress</span>
                    <span id="progressPercent">0%</span>
                </div>
                <div class="h-3 bg-white/10 rounded-full overflow-hidden">
                    <div id="progressBar"
                        class="h-full bg-gradient-to-r from-purple-500 to-pink-500 rounded-full transition-all duration-500"
                        style="width: 0%"></div>
                </div>
                <p class="text-center text-xs text-gray-500 mt-2">
                    <span id="soldCountSmall">0</span> / 1,000,000 <span data-en="cells sold" data-ar="ÿÆÿßŸÜÿ© ŸÖÿ®ÿßÿπÿ©">cells
                        sold</span>
                </p>
            </div>

            <a href="#grid"
                class="inline-block glow-btn px-8 sm:px-12 py-4 sm:py-5 rounded-full font-bold text-lg sm:text-xl shadow-2xl hover:scale-105 transition-transform">
                üü¢ <span data-en="Reserve Your Spot Now ‚Äì $2.00" data-ar="ÿßÿ≠ÿ¨ÿ≤ ŸÖŸÉÿßŸÜŸÉ ÿßŸÑÿ¢ŸÜ ‚Äì 2 ÿØŸàŸÑÿßÿ±">Reserve Your Spot
                    Now
                    ‚Äì $2.00</span>
            </a>

            <!-- ÿπŸÜÿßÿµÿ± ÿßŸÑÿ´ŸÇÿ© -->
            <div class="flex flex-wrap justify-center gap-4 mt-6 text-xs sm:text-sm text-gray-400">
                <span class="flex items-center gap-1">
                    üîí <span data-en="Secure Payment" data-ar="ÿØŸÅÿπ ÿ¢ŸÖŸÜ">Secure Payment</span>
                </span>
                <span class="flex items-center gap-1">
                    ‚úÖ <span data-en="No Hidden Fees" data-ar="ÿ®ÿØŸàŸÜ ÿ±ÿ≥ŸàŸÖ ÿÆŸÅŸäÿ©">No Hidden Fees</span>
                </span>
                <span class="flex items-center gap-1">
                    üáØüá¥ <span data-en="Jordanian Project" data-ar="ŸÖÿ¥ÿ±Ÿàÿπ ÿ£ÿ±ÿØŸÜŸä">Jordanian Project</span>
                </span>
            </div>

            <!-- Hall of Fame Ticker -->
            <div class="ticker-container">
                <div id="recentTicker" class="ticker-content">
                    <!-- Items injected via JS -->
                    <div class="ticker-item">üöÄ <span data-en="Museum Opening Soon..."
                            data-ar="ÿßŸÑŸÖÿ™ÿ≠ŸÅ ÿ≥ŸäŸÅÿ™ÿ≠ ŸÇÿ±Ÿäÿ®ÿßŸã...">Museum Opening Soon...</span></div>
                    <div class="ticker-item">‚ú® <span data-en="Join the Pioneers" data-ar="ÿßŸÜÿ∂ŸÖ ÿ•ŸÑŸâ ÿßŸÑÿ±ŸàÿßÿØ">Join the
                            Pioneers</span></div>
                    <div class="ticker-item">üíé <span data-en="Your Legacy Forever" data-ar="ÿ•ÿ±ÿ´ŸÉ ŸÑŸÑÿ£ÿ®ÿØ">Your Legacy
                            Forever</span></div>
                </div>
            </div>

            <div class="mt-12">
                <svg class="w-6 h-6 mx-auto text-purple-500/50 animate-bounce" fill="none" stroke="currentColor"
                    viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M19 14l-7 7m0 0l-7-7m7 7V3"></path>
                </svg>
            </div>
        </div>
    </section>

    <!-- Why People Joined - Social Proof -->
    <section class="py-16 bg-gradient-to-r from-purple-500/5 to-pink-500/5">
        <div class="max-w-4xl mx-auto px-4">
            <h2 class="text-xl sm:text-2xl font-bold text-center mb-8">
                <span class="gradient-text" data-en="Why People Joined?" data-ar="ŸÑŸäÿ¥ ÿßŸÑŸÜÿßÿ≥ ÿ≠ÿ¨ÿ≤ÿ™ÿü">Why People
                    Joined?</span>
            </h2>
            <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                <div class="glass-card p-4 text-center hover:scale-105 transition">
                    <span class="text-3xl mb-2 block">‚ù§Ô∏è</span>
                    <p class="text-sm text-gray-300" data-en="Memory of someone" data-ar="ÿ∞ŸÉÿ±Ÿâ ÿ¥ÿÆÿµ ÿπÿ≤Ÿäÿ≤">Memory of
                        someone</p>
                </div>
                <div class="glass-card p-4 text-center hover:scale-105 transition">
                    <span class="text-3xl mb-2 block">üöÄ</span>
                    <p class="text-sm text-gray-300" data-en="Start of a project" data-ar="ÿ®ÿØÿßŸäÿ© ŸÖÿ¥ÿ±Ÿàÿπ">Start of a
                        project</p>
                </div>
                <div class="glass-card p-4 text-center hover:scale-105 transition">
                    <span class="text-3xl mb-2 block">üáØüá¥</span>
                    <p class="text-sm text-gray-300" data-en="Pride in identity" data-ar="ŸÅÿÆÿ± ÿ®ÿßŸÑŸáŸàŸäÿ©">Pride in identity
                    </p>
                </div>
                <div class="glass-card p-4 text-center hover:scale-105 transition">
                    <span class="text-3xl mb-2 block">üí°</span>
                    <p class="text-sm text-gray-300" data-en="A cool idea" data-ar="ŸÅŸÉÿ±ÿ© ÿ≠ŸÑŸàÿ©">A cool idea</p>
                </div>
            </div>
            <p class="text-center text-gray-500 text-sm mt-6" data-en="Join them with just $2.00!"
                data-ar="ÿßŸÜÿ∂ŸÖ ÿ•ŸÑŸäŸáŸÖ ÿ®ŸÄ 2 ÿØŸàŸÑÿßÿ± ŸÅŸÇÿ∑!">Join them with just $2.00!</p>
        </div>
    </section>

    <!-- How It Works -->
    <section class="py-20">
        <div class="max-w-5xl mx-auto px-4">
            <h2 class="text-2xl sm:text-3xl font-bold text-center mb-12">
                <span class="gradient-text" data-en="How It Works" data-ar="ŸÉŸäŸÅ ŸäÿπŸÖŸÑ">How It Works</span>
            </h2>
            <div class="grid sm:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="glass-card p-6 text-center">
                    <div class="step-badge mx-auto mb-4">1</div>
                    <h3 class="font-semibold mb-2 text-white" data-en="Choose Your Cell" data-ar="ÿßÿÆÿ™ÿ± ÿÆÿßŸÜÿ™ŸÉ">Choose
                        Your Cell</h3>
                    <p class="text-gray-400 text-sm" data-en="Click on any available cell in the grid"
                        data-ar="ÿßÿ∂ÿ∫ÿ∑ ÿπŸÑŸâ ÿ£Ÿä ÿÆÿßŸÜÿ© ŸÖÿ™ÿßÿ≠ÿ© ŸÅŸä ÿßŸÑÿ¥ÿ®ŸÉÿ©">Click on any available cell in the grid</p>
                </div>
                <div class="glass-card p-6 text-center">
                    <div class="step-badge mx-auto mb-4">2</div>
                    <h3 class="font-semibold mb-2 text-white" data-en="Share Your Story" data-ar="ÿ¥ÿßÿ±ŸÉ ŸÇÿµÿ™ŸÉ">Share Your
                        Story</h3>
                    <p class="text-gray-400 text-sm" data-en="Add your name, special date, and story"
                        data-ar="ÿ£ÿ∂ŸÅ ÿßÿ≥ŸÖŸÉÿå ÿ™ÿßÿ±ŸäÿÆŸÉ ÿßŸÑŸÖŸáŸÖÿå ŸàŸÇÿµÿ™ŸÉ">Add your name, special date, and story</p>
                </div>
                <div class="glass-card p-6 text-center">
                    <div class="step-badge mx-auto mb-4">3</div>
                    <h3 class="font-semibold mb-2 text-white" data-en="Upload Your Logo" data-ar="ÿßÿ±ŸÅÿπ ÿ¥ÿπÿßÿ±ŸÉ">Upload
                        Your Logo</h3>
                    <p class="text-gray-400 text-sm" data-en="Add your photo or logo to represent you"
                        data-ar="ÿ£ÿ∂ŸÅ ÿµŸàÿ±ÿ™ŸÉ ÿ£Ÿà ÿ¥ÿπÿßÿ±ŸÉ ŸÑŸäŸÖÿ´ŸÑŸÉ">Add your photo or logo to represent you</p>
                </div>
                <div class="glass-card p-6 text-center">
                    <div class="step-badge mx-auto mb-4">4</div>
                    <h3 class="font-semibold mb-2 text-white" data-en="Instant Payment" data-ar="ÿØŸÅÿπ ŸÅŸàÿ±Ÿä">Instant
                        Payment</h3>
                    <p class="text-gray-400 text-sm" data-en="Quick payment via Card or Apple Pay"
                        data-ar="ÿØŸÅÿπ ÿ≥ÿ±Ÿäÿπ ÿπÿ®ÿ± ÿßŸÑÿ®ÿ∑ÿßŸÇÿ© ÿ£Ÿà ÿ£ÿ®ŸÑ ÿ®ÿßŸä">Quick payment via Card or Apple Pay</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Grid Section -->
    <section id="grid" class="py-20">
        <div class="max-w-7xl mx-auto px-4">
            <div class="text-center mb-8">
                <h2 class="text-2xl sm:text-3xl font-bold mb-3">
                    <span class="gradient-text" data-en="The Million Grid" data-ar="ÿßŸÑÿ¥ÿ®ŸÉÿ© ÿßŸÑŸÖŸÑŸäŸàŸÜŸäÿ©">The Million
                        Grid</span>
                </h2>
                <p class="text-gray-400 text-sm" data-en="Click on any dark cell to claim it!"
                    data-ar="ÿßÿ∂ÿ∫ÿ∑ ÿπŸÑŸâ ÿ£Ÿä ÿÆÿßŸÜÿ© ÿØÿßŸÉŸÜÿ© ŸÑÿ≠ÿ¨ÿ≤Ÿáÿß!">Click on any dark cell to claim it!</p>
            </div>

            <!-- Search Box -->
            <div class="max-w-md mx-auto mb-6">
                <div class="search-box flex items-center px-4 py-3">
                    <span class="text-gray-400 mr-3">üîç</span>
                    <input type="text" id="searchInput"
                        class="bg-transparent w-full outline-none text-white placeholder-gray-500 text-sm"
                        placeholder="Search by name..." data-placeholder-en="Search by name..."
                        data-placeholder-ar="ÿßÿ®ÿ≠ÿ´ ÿ®ÿßŸÑÿßÿ≥ŸÖ..." oninput="searchCells(this.value)">
                    <button onclick="clearSearch()" class="text-gray-500 hover:text-white ml-2 hidden"
                        id="clearSearchBtn">&times;</button>
                </div>
            </div>

            <!-- Grid Legend -->
            <div class="flex justify-center gap-6 mb-6">
                <div class="flex items-center gap-2">
                    <div class="w-3 h-3 rounded bg-[#1e1e3f] border border-purple-500/20"></div>
                    <span class="text-gray-500 text-xs" data-en="Available" data-ar="ŸÖÿ™ÿßÿ≠ÿ©">Available</span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-3 h-3 rounded bg-gradient-to-r from-purple-500 to-pink-500"></div>
                    <span class="text-gray-500 text-xs" data-en="Taken" data-ar="ŸÖÿ≠ÿ¨Ÿàÿ≤ÿ©">Taken</span>
                </div>
            </div>

            <!-- Search Results -->
            <div id="searchResults" class="hidden mb-6">
                <div class="glass-card p-4">
                    <h4 class="text-sm font-semibold text-purple-400 mb-3" data-en="Search Results:"
                        data-ar="ŸÜÿ™ÿßÿ¶ÿ¨ ÿßŸÑÿ®ÿ≠ÿ´:">Search Results:</h4>
                    <div id="searchResultsList" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3"></div>
                </div>
            </div>

            <!-- Canvas Controls -->
            <div class="canvas-controls">
                <button class="canvas-btn" onclick="zoomIn()">üîç+</button>
                <button class="canvas-btn" onclick="zoomOut()">üîç-</button>
                <button class="canvas-btn" onclick="resetView()">üîÑ</button>
                <button class="canvas-btn select-mode-btn" id="selectModeBtn" onclick="toggleSelectMode()">üéØ <span
                        data-en="Select" data-ar="ÿßÿÆÿ™Ÿäÿßÿ±">Select</span></button>
                <button class="canvas-btn" onclick="selectRandomCell()">üé≤ <span data-en="Random"
                        data-ar="ÿπÿ¥Ÿàÿßÿ¶Ÿä">Random</span></button>
                <span class="zoom-display" id="zoomLevel">100%</span>
            </div>

            <!-- Mobile Instructions -->
            <div class="text-center mb-4 sm:hidden">
                <p class="text-xs text-purple-400" id="mobileHint" data-en="üëÜ Tap 'Select' then tap a cell"
                    data-ar="üëÜ ÿßÿ∂ÿ∫ÿ∑ 'ÿßÿÆÿ™Ÿäÿßÿ±' ÿ´ŸÖ ÿßÿÆÿ™ÿ± ÿÆÿßŸÜÿ©">üëÜ Tap 'Select' then tap a cell</p>
            </div>

            <!-- Canvas Grid Container -->
            <div class="canvas-container" id="canvasContainer">
                <canvas id="gridCanvas"></canvas>
                <div class="coordinates-display" id="coordsDisplay">X: 0, Y: 0 | Cell: -</div>
                <div id="cellTooltip" class="cell-tooltip hidden"></div>
                <div class="mini-map" id="miniMap">
                    <canvas id="miniMapCanvas"></canvas>
                    <div class="viewport-indicator" id="viewportIndicator"></div>
                </div>
            </div>

            <div class="canvas-info">
                <span data-en="üñ±Ô∏è Scroll to zoom ‚Ä¢ Drag to pan ‚Ä¢ Click to select"
                    data-ar="üñ±Ô∏è ŸÖÿ±ÿ± ŸÑŸÑÿ™ŸÉÿ®Ÿäÿ± ‚Ä¢ ÿßÿ≥ÿ≠ÿ® ŸÑŸÑÿ™ŸÜŸÇŸÑ ‚Ä¢ ÿßÿ∂ÿ∫ÿ∑ ŸÑŸÑÿßÿÆÿ™Ÿäÿßÿ±">üñ±Ô∏è Scroll to zoom ‚Ä¢ Drag to pan ‚Ä¢ Click to
                    select</span>
            </div>

            <!-- Browse Random Stories Button -->
            <div class="text-center mt-6">
                <button onclick="browseRandomStory()"
                    class="glass-card px-6 py-3 hover:bg-white/10 transition inline-flex items-center gap-2">
                    <span class="text-xl">üé≤</span>
                    <span data-en="Browse Random Stories" data-ar="ÿ™ÿµŸÅÿ≠ ŸÇÿµÿµ ÿπÿ¥Ÿàÿßÿ¶Ÿäÿ©">Browse Random Stories</span>
                </button>
            </div>

            <!-- The First Three -->
            <div class="mt-16">
                <div class="text-center mb-10">
                    <p class="text-purple-400/60 text-xs uppercase tracking-widest mb-2" data-en="Hall of Fame"
                        data-ar="ŸÇÿßÿπÿ© ÿßŸÑÿ¥ÿ±ŸÅ">Hall of Fame</p>
                    <h3 class="text-xl sm:text-2xl font-bold text-white">
                        <span data-en="The First Three" data-ar="ÿßŸÑÿ´ŸÑÿßÿ´ÿ© ÿßŸÑÿ£Ÿàÿßÿ¶ŸÑ">The First Three</span>
                    </h3>
                    <p class="text-gray-500 mt-2 text-sm">
                        <span data-en="The pioneers who started it all" data-ar="ÿßŸÑÿ±ŸàÿßÿØ ÿßŸÑÿ∞ŸäŸÜ ÿ®ÿØÿ£Ÿàÿß ŸÉŸÑ ÿ¥Ÿäÿ°">The pioneers
                            who started it all</span>
                    </p>
                </div>

                <div id="foundingWall" class="grid grid-cols-1 sm:grid-cols-3 gap-4 max-w-3xl mx-auto">
                    <div class="founder-card">
                        <div class="founder-rank gold"><span>1st</span><span>Pioneer</span></div>
                        <div id="founder1Image"
                            class="founder-avatar bg-[#1e1e3f] flex items-center justify-center text-2xl text-gray-600">
                            ?</div>
                        <h4 id="founder1Name" class="font-semibold text-sm mt-4 text-gray-400" data-en="Awaiting..."
                            data-ar="ÿ®ÿßŸÜÿ™ÿ∏ÿßÿ±...">Awaiting...</h4>
                        <p id="founder1Story" class="text-gray-500 text-xs mt-2 line-clamp-2"></p>
                    </div>
                    <div class="founder-card">
                        <div class="founder-rank silver"><span>2nd</span><span>Pioneer</span></div>
                        <div id="founder2Image"
                            class="founder-avatar bg-[#1e1e3f] flex items-center justify-center text-2xl text-gray-600">
                            ?</div>
                        <h4 id="founder2Name" class="font-semibold text-sm mt-4 text-gray-400" data-en="Awaiting..."
                            data-ar="ÿ®ÿßŸÜÿ™ÿ∏ÿßÿ±...">Awaiting...</h4>
                        <p id="founder2Story" class="text-gray-500 text-xs mt-2 line-clamp-2"></p>
                    </div>
                    <div class="founder-card">
                        <div class="founder-rank bronze"><span>3rd</span><span>Pioneer</span></div>
                        <div id="founder3Image"
                            class="founder-avatar bg-[#1e1e3f] flex items-center justify-center text-2xl text-gray-600">
                            ?</div>
                        <h4 id="founder3Name" class="font-semibold text-sm mt-4 text-gray-400" data-en="Awaiting..."
                            data-ar="ÿ®ÿßŸÜÿ™ÿ∏ÿßÿ±...">Awaiting...</h4>
                        <p id="founder3Story" class="text-gray-500 text-xs mt-2 line-clamp-2"></p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Charter Section -->
    <section class="py-20">
        <div class="max-w-4xl mx-auto px-4">
            <div class="gradient-border p-8 sm:p-10">
                <h2 class="text-2xl sm:text-3xl font-bold text-center mb-8">
                    üìú <span class="gradient-text" data-en="Our Promise" data-ar="ŸàÿπÿØŸÜÿß">Our Promise</span>
                </h2>

                <div class="grid sm:grid-cols-2 gap-4">
                    <div class="charter-card">
                        <span class="text-3xl mb-3 block">üí∞</span>
                        <h3 class="text-lg font-bold text-white" data-en="$2.00 Forever" data-ar="2 ÿØŸàŸÑÿßÿ± ŸÑŸÑÿ£ÿ®ÿØ">$2.00
                            Forever</h3>
                        <p class="text-gray-400 mt-2 text-sm" data-en="Price never changes" data-ar="ÿßŸÑÿ≥ÿπÿ± ŸÑŸÜ Ÿäÿ™ÿ∫Ÿäÿ±">
                            Price never changes</p>
                    </div>
                    <div class="charter-card">
                        <span class="text-3xl mb-3 block">üîí</span>
                        <h3 class="text-lg font-bold text-white" data-en="Never Deleted" data-ar="ŸÑŸÜ ÿ™Ÿèÿ≠ÿ∞ŸÅ">Never
                            Deleted</h3>
                        <p class="text-gray-400 mt-2 text-sm" data-en="Your story stays forever"
                            data-ar="ŸÇÿµÿ™ŸÉ ÿ™ÿ®ŸÇŸâ ŸÑŸÑÿ£ÿ®ÿØ">Your story stays forever</p>
                    </div>
                    <div class="charter-card">
                        <span class="text-3xl mb-3 block">‚ú®</span>
                        <h3 class="text-lg font-bold text-white" data-en="No Changes" data-ar="ŸÑÿß ÿ™ÿπÿØŸäŸÑ">No Changes</h3>
                        <p class="text-gray-400 mt-2 text-sm" data-en="Preserved as you wrote it"
                            data-ar="ŸÖÿ≠ŸÅŸàÿ∏ÿ© ŸÉŸÖÿß ŸÉÿ™ÿ®ÿ™Ÿáÿß">Preserved as you wrote it</p>
                    </div>
                    <div class="charter-card">
                        <span class="text-3xl mb-3 block">üèõÔ∏è</span>
                        <h3 class="text-lg font-bold text-white" data-en="Digital Museum" data-ar="ŸÖÿ™ÿ≠ŸÅ ÿ±ŸÇŸÖŸä">Digital
                            Museum</h3>
                        <p class="text-gray-400 mt-2 text-sm" data-en="Part of Arab digital history"
                            data-ar="ÿ¨ÿ≤ÿ° ŸÖŸÜ ÿßŸÑÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ±ŸÇŸÖŸä ÿßŸÑÿπÿ±ÿ®Ÿä">Part of Arab digital history</p>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <!-- Regional Leaderboard (Global Reach) -->
    <section class="py-20 bg-gradient-to-b from-transparent via-purple-500/5 to-transparent">
        <div class="max-w-6xl mx-auto px-4">
            <div class="text-center mb-16">
                <h2 class="text-3xl sm:text-5xl font-black mb-6 tracking-tight">
                    üåê <span class="gradient-text" data-en="Global Reach" data-ar="ÿßŸÑÿßŸÜÿ™ÿ¥ÿßÿ± ÿßŸÑÿπÿßŸÑŸÖŸä">Global Reach</span>
                </h2>
                <p class="text-gray-400 max-w-2xl mx-auto text-sm sm:text-base"
                    data-en="See which cities and countries are leading the museum's expansion."
                    data-ar="ÿ¥ÿßŸáÿØ ÿ£Ÿä ÿßŸÑŸÖÿØŸÜ ŸàÿßŸÑÿØŸàŸÑ ÿ™ÿ™ÿµÿØÿ± ÿ™Ÿàÿ≥ÿπ ÿßŸÑŸÖÿ™ÿ≠ŸÅ.">See which cities and countries are leading the
                    museum's expansion.</p>
            </div>

            <div class="max-w-4xl mx-auto">
                <!-- Leaderboard Card (Now centered and elegant) -->
                <div class="cyber-card p-8">
                    <h3 class="text-xl font-bold mb-8 flex items-center justify-center gap-3">
                        üèÜ <span data-en="Top Regions" data-ar="ÿ£ŸÉÿ´ÿ± ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ ŸÜÿ¥ÿßÿ∑ÿßŸã">Top Regions</span>
                    </h3>
                    <div id="leaderboardList" class="space-y-6 max-w-2xl mx-auto">
                        <!-- Loading State -->
                        <div class="animate-pulse space-y-4">
                            <div class="h-4 bg-white/5 rounded w-3/4"></div>
                            <div class="h-4 bg-white/5 rounded w-1/2"></div>
                            <div class="h-4 bg-white/5 rounded w-2/3"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- FAQ Section -->
    <section class="py-20">
        <div class="max-w-3xl mx-auto px-4">
            <h2 class="text-2xl sm:text-3xl font-bold text-center mb-12">
                <span class="gradient-text" data-en="Frequently Asked Questions" data-ar="ÿßŸÑÿ£ÿ≥ÿ¶ŸÑÿ© ÿßŸÑÿ¥ÿßÿ¶ÿπÿ©">Frequently
                    Asked Questions</span>
            </h2>

            <div class="space-y-4">
                <div class="faq-item">
                    <div class="faq-question" onclick="toggleFaq(this)">
                        <span class="font-semibold text-white text-sm sm:text-base"
                            data-en="What do I get when I buy a cell?" data-ar="ŸÖÿßÿ∞ÿß ÿ£ÿ≠ÿµŸÑ ÿπŸÜÿØ ÿ¥ÿ±ÿßÿ° ÿÆÿßŸÜÿ©ÿü">What do I get
                            when I buy a cell?</span>
                        <span class="faq-icon text-purple-400">‚ñº</span>
                    </div>
                    <div class="faq-answer">
                        <p class="px-5 pb-5 text-gray-400 text-sm"
                            data-en="Your logo/photo appears permanently on the grid. When anyone clicks on it, they see your name, story, and special date. It's your digital legacy forever!"
                            data-ar="ÿ¥ÿπÿßÿ±ŸÉ/ÿµŸàÿ±ÿ™ŸÉ ÿ™ÿ∏Ÿáÿ± ÿ®ÿ¥ŸÉŸÑ ÿØÿßÿ¶ŸÖ ÿπŸÑŸâ ÿßŸÑÿ¥ÿ®ŸÉÿ©. ÿπŸÜÿØŸÖÿß Ÿäÿ∂ÿ∫ÿ∑ ÿ£Ÿä ÿ¥ÿÆÿµ ÿπŸÑŸäŸáÿßÿå Ÿäÿ±Ÿâ ÿßÿ≥ŸÖŸÉ ŸàŸÇÿµÿ™ŸÉ Ÿàÿ™ÿßÿ±ŸäÿÆŸÉ ÿßŸÑŸÖŸÖŸäÿ≤. ÿ•ŸÜŸá ÿ•ÿ±ÿ´ŸÉ ÿßŸÑÿ±ŸÇŸÖŸä ŸÑŸÑÿ£ÿ®ÿØ!">
                            Your logo/photo appears permanently on the grid. When anyone clicks on it, they see your
                            name, story, and special date. It's your digital legacy forever!</p>
                    </div>
                </div>

                <div class="faq-item">
                    <div class="faq-question" onclick="toggleFaq(this)">
                        <span class="font-semibold text-white text-sm sm:text-base" data-en="How do I pay?"
                            data-ar="ŸÉŸäŸÅ ÿ£ÿØŸÅÿπÿü">How do I pay?</span>
                        <span class="faq-icon text-purple-400">‚ñº</span>
                    </div>
                    <div class="faq-answer">
                        <p class="px-5 pb-5 text-gray-400 text-sm"
                            data-en="You can pay instantly via Credit Card or Apple Pay using Gumroad. It's safe, fast, and automatic!"
                            data-ar="ŸäŸÖŸÉŸÜŸÉ ÿßŸÑÿØŸÅÿπ ŸÅŸàÿ±ÿßŸã ÿπÿ®ÿ± ÿßŸÑÿ®ÿ∑ÿßŸÇÿ© ÿ£Ÿà ÿ£ÿ®ŸÑ ÿ®ÿßŸä ÿ®ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ Gumroad. ÿßŸÑÿ∑ÿ±ŸäŸÇÿ© ÿ¢ŸÖŸÜÿ© Ÿàÿ≥ÿ±Ÿäÿπÿ© Ÿàÿ™ŸÑŸÇÿßÿ¶Ÿäÿ©!">
                            You can pay instantly via Credit Card or Apple Pay using Gumroad. It's safe, fast, and
                            automatic!</p>
                    </div>
                </div>

                <div class="faq-item">
                    <div class="faq-question" onclick="toggleFaq(this)">
                        <span class="font-semibold text-white text-sm sm:text-base"
                            data-en="Can I edit my cell after purchase?" data-ar="ŸáŸÑ ŸäŸÖŸÉŸÜŸÜŸä ÿ™ÿπÿØŸäŸÑ ÿÆÿßŸÜÿ™Ÿä ÿ®ÿπÿØ ÿßŸÑÿ¥ÿ±ÿßÿ°ÿü">Can
                            I edit my cell after purchase?</span>
                        <span class="faq-icon text-purple-400">‚ñº</span>
                    </div>
                    <div class="faq-answer">
                        <p class="px-5 pb-5 text-gray-400 text-sm"
                            data-en="No. Once confirmed, your cell becomes part of the permanent archive. This ensures authenticity and historical value."
                            data-ar="ŸÑÿß. ÿ®ŸÖÿ¨ÿ±ÿØ ÿßŸÑÿ™ÿ£ŸÉŸäÿØÿå ÿ™ÿµÿ®ÿ≠ ÿÆÿßŸÜÿ™ŸÉ ÿ¨ÿ≤ÿ°ÿßŸã ŸÖŸÜ ÿßŸÑÿ£ÿ±ÿ¥ŸäŸÅ ÿßŸÑÿØÿßÿ¶ŸÖ. Ÿáÿ∞ÿß Ÿäÿ∂ŸÖŸÜ ÿßŸÑŸÖÿµÿØÿßŸÇŸäÿ© ŸàÿßŸÑŸÇŸäŸÖÿ© ÿßŸÑÿ™ÿßÿ±ŸäÿÆŸäÿ©.">
                            No. Once confirmed, your cell becomes part of the permanent archive. This ensures
                            authenticity and historical value.</p>
                    </div>
                </div>

                <div class="faq-item">
                    <div class="faq-question" onclick="toggleFaq(this)">
                        <span class="font-semibold text-white text-sm sm:text-base"
                            data-en="What happens after all cells are sold?"
                            data-ar="ŸÖÿßÿ∞ÿß Ÿäÿ≠ÿØÿ´ ÿ®ÿπÿØ ÿ®Ÿäÿπ ŸÉŸÑ ÿßŸÑÿÆÿßŸÜÿßÿ™ÿü">What happens after all cells are sold?</span>
                        <span class="faq-icon text-purple-400">‚ñº</span>
                    </div>
                    <div class="faq-answer">
                        <p class="px-5 pb-5 text-gray-400 text-sm"
                            data-en="The page becomes a permanent digital museum - the first Arabic advertising archive. No more purchases, just viewing a piece of history."
                            data-ar="ÿ™ÿµÿ®ÿ≠ ÿßŸÑÿµŸÅÿ≠ÿ© ŸÖÿ™ÿ≠ŸÅÿßŸã ÿ±ŸÇŸÖŸäÿßŸã ÿØÿßÿ¶ŸÖÿßŸã - ÿ£ŸàŸÑ ÿ£ÿ±ÿ¥ŸäŸÅ ÿ•ÿπŸÑÿßŸÜŸä ÿπÿ±ÿ®Ÿä. ŸÑÿß ŸÖÿ≤ŸäÿØ ŸÖŸÜ ÿßŸÑÿ¥ÿ±ÿßÿ°ÿå ŸÅŸÇÿ∑ ŸÖÿ¥ÿßŸáÿØÿ© ŸÇÿ∑ÿπÿ© ŸÖŸÜ ÿßŸÑÿ™ÿßÿ±ŸäÿÆ.">
                            The page becomes a permanent digital museum - the first Arabic advertising archive. No more
                            purchases, just viewing a piece of history.</p>
                    </div>
                </div>


            </div>
        </div>
    </section>

    <!-- ŸÇÿ≥ŸÖ ÿßŸÑÿ™ŸàÿßÿµŸÑ ŸàÿßŸÑÿ´ŸÇÿ© -->
    <section class="py-12 bg-gradient-to-r from-purple-500/5 to-pink-500/5">
        <div class="max-w-4xl mx-auto px-4">
            <div class="glass-card p-6 sm:p-8 text-center">
                <h3 class="text-xl sm:text-2xl font-bold text-white mb-4">
                    üí¨ <span data-en="Have Questions?" data-ar="ÿπŸÜÿØŸÉ ÿ£ÿ≥ÿ¶ŸÑÿ©ÿü">Have Questions?</span>
                </h3>
                <p class="text-gray-400 mb-6 text-sm sm:text-base" data-en="We're here to help! Contact us anytime."
                    data-ar="ŸÜÿ≠ŸÜ ŸáŸÜÿß ŸÑŸÑŸÖÿ≥ÿßÿπÿØÿ©! ÿ™ŸàÿßÿµŸÑ ŸÖÿπŸÜÿß ŸÅŸä ÿ£Ÿä ŸàŸÇÿ™.">We're here to help! Contact us anytime.</p>

                <div class="flex flex-wrap justify-center gap-4">
                    <a href="https://wa.me/962775925599" target="_blank"
                        class="flex items-center gap-2 bg-green-500/20 hover:bg-green-500/30 border border-green-500/30 px-6 py-3 rounded-xl transition">
                        <span class="text-xl">üì±</span>
                        <span class="text-green-400 font-semibold">WhatsApp</span>
                    </a>
                    <a href="mailto:ezz2006m@gmail.com"
                        class="flex items-center gap-2 bg-purple-500/20 hover:bg-purple-500/30 border border-purple-500/30 px-6 py-3 rounded-xl transition">
                        <span class="text-xl">‚úâÔ∏è</span>
                        <span class="text-purple-400 font-semibold">Email</span>
                    </a>
                </div>

                <div class="mt-6 pt-6 border-t border-white/5">
                    <div class="flex flex-wrap justify-center gap-6 text-sm text-gray-500">
                        <span class="flex items-center gap-2">
                            üîí <span data-en="Secure & Safe" data-ar="ÿ¢ŸÖŸÜ ŸàŸÖÿ≠ŸÖŸä">Secure & Safe</span>
                        </span>
                        <span class="flex items-center gap-2">
                            üíØ <span data-en="$2.00 = Forever" data-ar="2 ÿØŸàŸÑÿßÿ± = ŸÑŸÑÿ£ÿ®ÿØ">$2.00 = Forever</span>
                        </span>
                        <span class="flex items-center gap-2">
                            üáØüá¥ <span data-en="Made in Jordan" data-ar="ÿµŸÜÿπ ŸÅŸä ÿßŸÑÿ£ÿ±ÿØŸÜ">Made in Jordan</span>
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Warm Ending Section -->
    <section class="py-16 text-center">
        <div class="max-w-3xl mx-auto px-4">
            <div class="glass-card p-8 sm:p-12">
                <span class="text-5xl sm:text-6xl mb-6 block">ü§ç</span>
                <h3 class="text-2xl sm:text-3xl font-bold text-white mb-4">
                    <span data-en="Thank you for being here" data-ar="ÿ¥ŸÉÿ±ÿßŸã ŸÑÿ£ŸÜŸÉ ŸáŸÜÿß">Thank you for being here</span>
                </h3>
                <p class="text-gray-400 text-sm sm:text-base leading-relaxed mb-6"
                    data-en="Thank you for thinking about being part of this idea. Together, we are building Arab digital history - one cell at a time."
                    data-ar="ÿ¥ŸÉÿ±ÿßŸã ŸÑÿ£ŸÜŸÉ ŸÅŸÉÿ±ÿ™ ÿ™ŸÉŸàŸÜ ÿ¨ÿ≤ÿ° ŸÖŸÜ ŸáÿßŸÑŸÅŸÉÿ±ÿ©. ŸÖÿπÿßŸã ŸÜÿ®ŸÜŸä ÿßŸÑÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ±ŸÇŸÖŸä ÿßŸÑÿπÿ±ÿ®Ÿä - ÿÆÿßŸÜÿ© ÿ®ÿÆÿßŸÜÿ©.">Thank
                    you for thinking about being part of this idea. Together, we are building Arab digital history - one
                    cell at a time.</p>

                <p class="text-purple-400 text-lg sm:text-xl font-semibold mb-8">
                    <span data-en="Your name deserves to be part of history üåü"
                        data-ar="ÿßÿ≥ŸÖŸÉ Ÿäÿ≥ÿ™ÿ≠ŸÇ ÿ£ŸÜ ŸäŸÉŸàŸÜ ÿ¨ÿ≤ÿ°ÿßŸã ŸÖŸÜ ÿßŸÑÿ™ÿßÿ±ŸäÿÆ üåü">Your name deserves to be part of history
                        üåü</span>
                </p>

                <a href="#grid"
                    class="inline-block glow-btn px-8 sm:px-10 py-4 rounded-full font-bold text-base sm:text-lg shadow-2xl hover:scale-105 transition-transform">
                    üü¢ <span data-en="Reserve Your Spot ‚Äì $2.00" data-ar="ŸÖÿ≥ÿßŸáŸÖÿ© ÿ±ŸÖÿ≤Ÿäÿ© ‚Äì 2 ÿØŸàŸÑÿßÿ±">Reserve Your Spot ‚Äì
                        $2.00</span>
                </a>

                <p class="text-gray-500 text-xs mt-6" data-en="A symbolic contribution ‚Ä¢ Your legacy forever"
                    data-ar="ŸÖÿ≥ÿßŸáŸÖÿ© ÿ±ŸÖÿ≤Ÿäÿ© ‚Ä¢ ÿ•ÿ±ÿ´ŸÉ ŸÑŸÑÿ£ÿ®ÿØ">A symbolic contribution ‚Ä¢ Your legacy forever</p>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="py-10 border-t border-white/5">
        <div class="max-w-6xl mx-auto px-4">
            <div class="flex flex-wrap justify-between items-center gap-6">
                <div class="flex items-center gap-3">
                    <div
                        class="w-10 h-10 rounded-xl bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center text-xl font-bold">
                        M</div>
                    <span class="text-lg font-bold text-white">Million Logo</span>
                </div>
                <div class="text-gray-500 text-sm">
                    <span data-en="An idea by SMADI üáØüá¥" data-ar="ŸÅŸÉÿ±ÿ© SMADI üáØüá¥">An idea by
                        SMADI üáØüá¥</span>
                </div>
                <div class="flex gap-4">
                    <a href="https://wa.me/962775925599" target="_blank"
                        class="text-gray-500 hover:text-green-400 transition text-sm">WhatsApp</a>
                    <a href="mailto:ezz2006m@gmail.com"
                        class="text-gray-500 hover:text-purple-400 transition text-sm">Email</a>
                </div>
            </div>
        </div>
    </footer>

    <!-- Flag Selector Modal (Searchable) -->
    <div id="flagSelectorModal" class="fixed inset-0 modal-overlay z-[60] hidden items-center justify-center p-4">
        <div
            class="bg-[#0f0f24] border border-purple-500/30 w-full max-w-md rounded-3xl shadow-2xl overflow-hidden flex flex-col max-h-[80vh]">
            <div class="p-4 border-b border-white/5 flex justify-between items-center">
                <h3 class="text-white font-bold" data-en="Select Country" data-ar="ÿßÿÆÿ™ÿ± ÿßŸÑÿØŸàŸÑÿ©">Select Country</h3>
                <button onclick="closeFlagSelector()" class="text-gray-400 hover:text-white">‚úï</button>
            </div>
            <div class="p-4">
                <div class="relative group">
                    <div class="absolute inset-y-0 left-3 flex items-center pointer-events-none">
                        <span class="text-gray-500">üîç</span>
                    </div>
                    <input type="text" id="flagSearchInput" oninput="filterCountries()"
                        class="w-full bg-white/5 border border-white/10 rounded-xl py-2 pl-10 pr-4 text-white focus:outline-none focus:border-purple-500 transition"
                        placeholder="Search country... / ÿßÿ®ÿ≠ÿ´ ÿπŸÜ ÿØŸàŸÑÿ©...">
                </div>
            </div>
            <div id="countryList" class="flex-1 overflow-y-auto p-2 space-y-1 scrollbar-hide">
                <!-- Countries will be injected here -->
            </div>
        </div>
    </div>

    <!-- Claim Cell Modal -->
    <div id="claimModal"
        class="fixed inset-0 modal-overlay z-50 hidden items-center justify-center p-2 sm:p-4 overflow-y-auto">
        <div
            class="bg-[#0f0f24] border border-purple-500/30 w-full max-w-md sm:max-w-lg relative my-4 sm:my-8 rounded-3xl shadow-[0_30px_100px_rgba(0,0,0,0.8),0_0_20px_rgba(139,92,246,0.1)]">
            <div class="p-4 sm:p-6 border-b border-white/5">
                <button onclick="closeClaimModal()"
                    class="absolute top-3 right-3 sm:top-4 sm:right-4 w-8 h-8 bg-black/40 hover:bg-white/10 rounded-full flex items-center justify-center text-gray-400 hover:text-white transition border border-white/5">‚úï</button>

                <div class="flex justify-center gap-2 mb-4">
                    <div id="stepDot1"
                        class="w-2.5 h-2.5 rounded-full bg-purple-500 shadow-[0_0_10px_rgba(139,92,246,0.6)]"></div>
                    <div id="stepDot2" class="w-2.5 h-2.5 rounded-full bg-gray-700"></div>
                    <div id="stepDot3" class="w-2.5 h-2.5 rounded-full bg-gray-700"></div>
                </div>

                <div class="text-center">
                    <div id="stepIcon" class="text-3xl sm:text-4xl mb-2">‚ú®</div>
                    <h3 id="stepTitle" class="text-lg sm:text-xl font-bold text-white">
                        <span data-en="Share Your Story" data-ar="ÿ¥ÿßÿ±ŸÉ ŸÇÿµÿ™ŸÉ">Share Your Story</span>
                    </h3>
                    <p class="text-gray-500 text-xs sm:text-sm mt-1">
                        <span data-en="Cell #" data-ar="ÿÆÿßŸÜÿ© #">Cell #</span><span id="selectedCellId"
                            class="text-purple-400 font-bold">0</span>
                    </p>
                </div>
            </div>

            <div class="p-4 sm:p-6">
                <!-- Step 1: Your Story (Redesigned) -->
                <!-- Step 1: Your Story (Perfected) -->
                <div id="step1" class="step-content">
                    <!-- Live Preview Title -->
                    <div class="flex items-center gap-2 mb-4 px-1">
                        <span class="text-lg">üëÄ</span>
                        <h4 class="text-xs font-bold uppercase tracking-[0.2em] text-purple-400/80"
                            data-en="Live Preview" data-ar="ŸÖÿπÿßŸäŸÜÿ© ŸÖÿ®ÿßÿ¥ÿ±ÿ©">Live Preview</h4>
                    </div>

                    <!-- Enhanced Live Preview Box -->
                    <div
                        class="bg-[#050510] border border-purple-500/30 rounded-2xl mb-6 relative overflow-hidden group p-5 shadow-inner">
                        <div class="absolute inset-0 bg-gradient-to-br from-purple-500/5 to-transparent opacity-30">
                        </div>

                        <div class="relative z-10 text-center">
                            <!-- Mini Grid Simulation -->
                            <p class="text-[10px] text-purple-300/60 uppercase font-black tracking-[0.2em] mb-3"
                                data-en="Your spot in the crowd" data-ar="ŸÖŸàŸÇÿπŸÉ ÿ®ŸäŸÜ ÿßŸÑÿ¨ŸÖŸäÿπ">Your spot in the crowd</p>
                            <div class="flex justify-center mb-8">
                                <div
                                    class="grid grid-cols-3 gap-1.5 p-2 bg-[#0f0f1a] rounded-xl border border-white/5 shadow-2xl scale-110 sm:scale-125 transition-transform duration-500 hover:scale-[1.3]">
                                    <!-- Row 1 -->
                                    <div class="w-8 h-8 rounded-sm bg-purple-500/10 border border-white/5 opacity-40">
                                    </div>
                                    <div class="w-8 h-8 rounded-sm bg-pink-500/10 border border-white/5 opacity-30">
                                    </div>
                                    <div class="w-8 h-8 rounded-sm bg-blue-500/10 border border-white/5 opacity-40">
                                    </div>
                                    <!-- Row 2 -->
                                    <div class="w-8 h-8 rounded-sm bg-[#1a1a35] border border-white/5 opacity-50">
                                    </div>
                                    <!-- USER CELL (CENTER) -->
                                    <div id="previewGridCell"
                                        class="w-8 h-8 rounded-sm bg-gradient-to-br from-purple-600 to-pink-600 shadow-[0_0_15px_rgba(139,92,246,0.6)] border-2 border-white ring-2 ring-purple-600/50 flex items-center justify-center overflow-hidden transition-all duration-300">
                                        <span class="text-white text-xs font-bold">üéØ</span>
                                    </div>
                                    <div class="w-8 h-8 rounded-sm bg-[#12122b] border border-white/5 opacity-30">
                                    </div>
                                    <!-- Row 3 -->
                                    <div class="w-8 h-8 rounded-sm bg-[#241a35] border border-white/5 opacity-40">
                                    </div>
                                    <div class="w-8 h-8 rounded-sm bg-[#1a1a35] border border-white/5 opacity-30">
                                    </div>
                                    <div class="w-8 h-8 rounded-sm bg-[#12122b] border border-white/5 opacity-50">
                                    </div>
                                </div>
                            </div>

                            <!-- High-Fidelity Tooltip Preview -->
                            <div class="max-w-[240px] mx-auto transform hover:scale-[1.02] transition-all duration-300">
                                <p class="text-[10px] text-gray-500 uppercase tracking-widest mb-3 text-center"
                                    data-en="How others will see it" data-ar="ŸÉŸäŸÅ ÿ≥Ÿäÿ±ÿßŸÉ ÿßŸÑÿ¢ÿÆÿ±ŸàŸÜ">How others will see it
                                </p>
                                <div
                                    class="relative p-4 rounded-2xl bg-[#16162a]/95 border border-purple-500/40 shadow-[0_15px_50px_rgba(0,0,0,0.6),0_0_20px_rgba(139,92,246,0.2)] backdrop-blur-xl">
                                    <div id="previewTooltipAvatar"
                                        class="w-16 h-16 rounded-xl bg-gradient-to-br from-purple-500 to-pink-500 mx-auto mb-3 border-2 border-white/10 shadow-lg flex items-center justify-center overflow-hidden">
                                        <span class="text-2xl opacity-50">‚ú®</span>
                                    </div>
                                    <div id="previewName"
                                        class="text-sm font-black text-white text-center mb-1 truncate flex items-center justify-center gap-2">
                                        <span id="previewFlag">üáØüá¥</span>
                                        <span id="previewNameText">Your Name</span>
                                    </div>
                                    <div
                                        class="text-[9px] text-purple-400 font-bold text-center mb-2 tracking-tighter uppercase">
                                        Cell #<span id="previewCellIdDisplay">0</span></div>
                                    <div id="previewDateWrapper"
                                        class="flex items-center justify-center gap-1.5 mb-3 text-pink-400">
                                        <span class="text-[10px]">üìÖ</span>
                                        <span id="previewDate" class="text-[10px] font-bold">2026-02-18</span>
                                    </div>
                                    <div class="border-t border-white/10 pt-3 text-center">
                                        <div id="previewStory"
                                            class="text-[11px] text-gray-400 leading-relaxed italic line-clamp-2"
                                            data-en="Your amazing story will appear here..."
                                            data-ar="ŸÇÿµÿ™ŸÉ ÿßŸÑÿ±ÿßÿ¶ÿπÿ© ÿ≥ÿ™ÿ∏Ÿáÿ± ŸáŸÜÿß...">"Your amazing story will appear here..."
                                        </div>
                                    </div>
                                    <div class="flex justify-center gap-4 mt-3 pt-3 border-t border-white/5 opacity-60">
                                        <div class="flex items-center gap-1 text-[10px] text-pink-400">‚ù§Ô∏è 0</div>
                                        <div class="flex items-center gap-1 text-[10px] text-blue-400">üí¨ 0</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-5 mb-5">
                        <!-- Name Input -->
                        <div class="group relative">
                            <div
                                class="absolute -inset-0.5 bg-gradient-to-r from-purple-600 to-pink-600 rounded-2xl opacity-50 group-focus-within:opacity-100 transition duration-500 blur-[2px]">
                            </div>
                            <div class="relative bg-black/40 rounded-2xl p-4 h-full border border-white/5">
                                <label
                                    class="flex items-center gap-2 text-purple-400 mb-2 text-xs font-bold uppercase tracking-widest">
                                    <span class="text-lg">üë§</span>
                                    <span data-en="Who are you?" data-ar="ŸÖŸÜ ÿ£ŸÜÿ™ÿü">Who are you?</span>
                                </label>
                                <input type="text" id="userName"
                                    class="w-full bg-transparent border-none p-0 text-white placeholder-gray-600 focus:ring-0 text-lg font-semibold tracking-wide"
                                    placeholder="Name or Brand">
                            </div>
                        </div>

                        <!-- Country Select (Searchable) -->
                        <div class="group relative">
                            <div
                                class="absolute -inset-0.5 bg-gradient-to-r from-cyan-500 to-blue-600 rounded-2xl opacity-50 group-hover:opacity-100 transition duration-500 blur-[2px]">
                            </div>
                            <div class="relative bg-black/40 rounded-2xl p-4 h-full border border-white/5 cursor-pointer"
                                onclick="openFlagSelector()">
                                <label
                                    class="flex items-center gap-2 text-cyan-400 mb-2 text-xs font-bold uppercase tracking-widest pointer-events-none">
                                    <span class="text-lg">üåç</span>
                                    <span data-en="Your Origin" data-ar="ŸÖŸàÿ∑ŸÜŸÉ">Your Origin</span>
                                </label>
                                <div id="selectedCountryDisplay" class="flex items-center gap-3">
                                    <span id="currentFlagDisplay" class="text-2xl">üáØüá¥</span>
                                    <span id="currentCountryName" class="text-lg font-semibold text-white">Jordan</span>
                                </div>
                                <input type="hidden" id="userCountry" value="JO">
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-1 gap-5 mb-5">
                        <!-- Date Input -->
                        <div class="group relative">
                            <div
                                class="absolute -inset-0.5 bg-gradient-to-r from-pink-600 to-orange-600 rounded-2xl opacity-50 group-focus-within:opacity-100 transition duration-500 blur-[2px]">
                            </div>
                            <div class="relative bg-black/40 rounded-2xl p-4 h-full border border-white/5">
                                <label
                                    class="flex items-center gap-2 text-pink-400 mb-2 text-xs font-bold uppercase tracking-widest">
                                    <span class="text-lg">üìÖ</span>
                                    <span data-en="Important Date" data-ar="ÿ™ÿßÿ±ŸäÿÆ ŸÖŸáŸÖ">Important Date</span>
                                </label>
                                <input type="date" id="specialDate"
                                    class="w-full bg-transparent border-none p-0 text-white focus:ring-0 text-lg font-semibold tracking-wide cursor-pointer opacity-90 hover:opacity-100 transition">
                            </div>
                        </div>
                    </div>

                    <!-- Story Input -->
                    <div class="group relative mb-5">
                        <div
                            class="absolute -inset-0.5 bg-gradient-to-r from-blue-600 to-purple-600 rounded-2xl opacity-50 group-focus-within:opacity-100 transition duration-500 blur-[2px]">
                        </div>
                        <div class="relative bg-[#16162a] rounded-2xl p-4">
                            <label
                                class="flex items-center gap-2 text-blue-400 mb-2 text-xs font-bold uppercase tracking-widest">
                                <span class="text-lg">‚úçÔ∏è</span>
                                <span data-en="Your Legacy Message" data-ar="ÿ±ÿ≥ÿßŸÑÿ™ŸÉ ŸÑŸÑÿ™ÿßÿ±ŸäÿÆ">Your Legacy Message</span>
                            </label>
                            <textarea id="userStory"
                                class="w-full bg-transparent border-none p-0 text-white placeholder-gray-600 focus:ring-0 text-sm leading-relaxed resize-none h-24 scrollbar-hide"
                                placeholder="What do you want the world to know?"></textarea>
                        </div>
                    </div>

                    <!-- Image Upload (Premium Area) -->
                    <div class="group relative cursor-pointer" onclick="document.getElementById('imageInput').click()">
                        <div
                            class="absolute -inset-0.5 bg-gradient-to-r from-green-500 to-emerald-500 rounded-2xl opacity-30 group-hover:opacity-100 transition duration-500 blur-[2px]">
                        </div>
                        <div class="relative bg-[#16162a] rounded-2xl p-1 overflow-hidden">
                            <div id="uploadZone"
                                class="bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iMSIgY3k9IjEiIHI9IjEiIGZpbGw9InJnYmEoMjU1LDI1NSwyNTUsMC4wNSkiLz48L3N2Zz4=')] p-6 text-center transition-all group-hover:bg-[#1a1a35]">
                                <input type="file" id="imageInput" accept="image/*" class="hidden"
                                    onchange="handleImageUpload(this)">

                                <div id="uploadPlaceholder" class="space-y-3">
                                    <div
                                        class="w-16 h-16 mx-auto bg-gradient-to-tr from-green-500/20 to-emerald-500/20 rounded-full flex items-center justify-center border border-green-500/30 group-hover:scale-110 transition duration-300 shadow-[0_0_15px_rgba(16,185,129,0.2)]">
                                        <span class="text-2xl">üì∏</span>
                                    </div>
                                    <div>
                                        <h4 class="text-white font-bold text-sm tracking-wide" data-en="Upload Photo"
                                            data-ar="ÿßÿ±ŸÅÿπ ÿµŸàÿ±ÿ™ŸÉ">Upload Photo</h4>
                                        <p class="text-green-400/60 text-[10px] mt-1 tracking-wider uppercase">PNG, JPG
                                            ‚Ä¢ Max 2MB</p>
                                    </div>
                                </div>

                                <div id="uploadPreview" class="hidden relative h-32 flex items-center justify-center">
                                    <img id="previewImage"
                                        class="h-28 w-28 rounded-full object-cover border-4 border-[#16162a] shadow-2xl relative z-10">
                                    <div class="absolute inset-0 flex items-center justify-center">
                                        <div class="w-28 h-28 bg-green-500/20 rounded-full blur-xl animate-pulse"></div>
                                    </div>
                                    <div
                                        class="absolute bottom-0 bg-green-500 text-black text-[10px] font-bold px-3 py-1 rounded-full shadow-lg z-20">
                                        ‚úì <span data-en="UPLOADED" data-ar="ÿ™ŸÖ ÿßŸÑÿ±ŸÅÿπ">UPLOADED</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <button onclick="goToPayment()"
                        class="w-full mt-8 group relative inline-flex items-center justify-center px-8 py-4 font-bold text-white transition-all duration-200 bg-gradient-to-r from-purple-500 to-pink-500 rounded-xl hover:from-purple-600 hover:to-pink-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-600 transform active:scale-[0.98]">
                        <span
                            class="absolute inset-0 w-full h-full -mt-1 rounded-lg opacity-30 bg-gradient-to-b from-transparent via-transparent to-black"></span>
                        <span class="text-lg mr-2">‚ú®</span>
                        <span class="relative text-lg" data-en="Lock It In" data-ar="ÿ™ÿ£ŸÉŸäÿØ Ÿàÿ≠ÿ¨ÿ≤ ÿßŸÑÿÆÿßŸÜÿ©">Lock It
                            In</span>
                        <span class="ml-2 transition-transform group-hover:translate-x-1">‚Üí</span>
                    </button>
                </div>

                <!-- Step 2: Payment (Perfected) -->
                <div id="step2" class="step-content hidden">
                    <div class="text-center mb-8 relative">
                        <div class="absolute inset-0 bg-green-500/20 blur-3xl rounded-full opacity-20"></div>
                        <div
                            class="relative inline-block p-4 rounded-full bg-gradient-to-br from-green-500/10 to-emerald-500/10 border border-green-500/20 mb-3 backdrop-blur-md shadow-[0_0_30px_rgba(16,185,129,0.2)]">
                            <span class="text-4xl filter drop-shadow-[0_0_10px_rgba(16,185,129,0.5)]">‚ö°</span>
                        </div>
                        <h3 class="text-2xl font-black text-white mb-2 tracking-tight" data-en="Instant Activation"
                            data-ar="ÿ™ŸÅÿπŸäŸÑ ŸÅŸàÿ±Ÿä">Instant Activation</h3>
                        <p class="text-gray-400 text-sm font-medium" data-en="Your legacy goes live immediately"
                            data-ar="ÿ•ÿ±ÿ´ŸÉ ÿ≥Ÿäÿ∏Ÿáÿ± ÿ£ŸÖÿßŸÖ ÿßŸÑÿπÿßŸÑŸÖ ŸÅŸàÿ±ÿßŸã">Your legacy goes live immediately</p>
                    </div>

                    <div
                        class="group relative overflow-hidden rounded-3xl mb-8 transform transition-all hover:scale-[1.02] duration-500">
                        <div
                            class="absolute -inset-0.5 bg-gradient-to-r from-purple-600 via-pink-600 to-purple-600 rounded-3xl opacity-75 blur-md group-hover:opacity-100 transition duration-500 animate-pulse">
                        </div>
                        <div class="relative bg-[#050510] rounded-3xl p-8 text-center border border-purple-500/30">
                            <div class="text-purple-300 text-xs font-bold uppercase tracking-widest mb-2"
                                data-en="Total Investment" data-ar="ÿßŸÑÿßÿ≥ÿ™ÿ´ŸÖÿßÿ± ÿßŸÑŸÉŸÑŸä">Total Investment</div>
                            <div class="flex justify-center items-baseline gap-1 mb-2">
                                <span
                                    class="text-6xl font-black text-transparent bg-clip-text bg-gradient-to-r from-white to-gray-300">$2.00</span>
                                <span class="text-xl text-gray-500 font-bold">USD</span>
                            </div>
                            <div class="text-[10px] text-gray-400 uppercase tracking-[0.2em] mb-6"
                                data-en="One Time ‚Ä¢ Forever" data-ar="ŸÖÿ±ÿ© Ÿàÿßÿ≠ÿØÿ© ‚Ä¢ ŸÑŸÑÿ£ÿ®ÿØ">One Time ‚Ä¢ Forever</div>

                            <!-- PayPal Button Container -->
                            <div id="paypal-button-container" class="w-full mt-2 relative z-10"></div>
                        </div>
                    </div>


                    <div class="mt-8 text-center">
                        <button type="button" onclick="goBack()"
                            class="text-xs text-gray-500 hover:text-white transition py-2 px-4 hover:bg-white/5 rounded-lg border border-transparent hover:border-white/5">
                            ‚Üê <span data-en="Back to Edit" data-ar="ÿßŸÑÿπŸàÿØÿ© ŸÑŸÑÿ™ÿπÿØŸäŸÑ">Back to Edit</span>
                        </button>
                    </div>
                </div>

                <!-- Step 3: Success (Perfected) -->
                <div id="step3" class="step-content hidden">
                    <div class="text-center py-8 relative">
                        <div
                            class="absolute inset-0 bg-gradient-to-b from-purple-600/20 to-pink-600/20 blur-3xl rounded-full opacity-30">
                        </div>

                        <div class="relative mb-8">
                            <div
                                class="text-7xl mb-4 animate-bounce-slow filter drop-shadow-[0_0_30px_rgba(236,72,153,0.5)]">
                                üéâ</div>
                            <h3 class="text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-purple-400 via-pink-400 to-white mb-2"
                                data-en="You're In History!" data-ar="ÿØÿÆŸÑÿ™ ÿßŸÑÿ™ÿßÿ±ŸäÿÆ!">You're In History!</h3>
                            <p class="text-gray-400 font-medium" data-en="Your cell is now live on the grid forever."
                                data-ar="ÿÆÿßŸÜÿ™ŸÉ ÿßŸÑÿ¢ŸÜ ŸÖÿ®ÿßÿ¥ÿ±ÿ© ÿπŸÑŸâ ÿßŸÑÿ¥ÿ®ŸÉÿ© ŸÑŸÑÿ£ÿ®ÿØ.">Your cell is now live on the grid forever.
                            </p>
                        </div>

                        <div
                            class="bg-[#16162a]/80 backdrop-blur-xl border border-purple-500/30 p-8 rounded-3xl relative overflow-hidden group shadow-2xl">
                            <div
                                class="absolute inset-0 bg-gradient-to-r from-purple-500/10 to-pink-500/10 opacity-0 group-hover:opacity-100 transition duration-700">
                            </div>

                            <div class="relative z-10">
                                <div class="text-xs text-purple-300 font-bold uppercase tracking-widest mb-2"
                                    data-en="Your Cell ID" data-ar="ÿ±ŸÇŸÖ ÿÆÿßŸÜÿ™ŸÉ">Your Cell ID</div>
                                <div class="text-6xl font-black text-white tracking-tighter mb-6 font-mono">#<span
                                        id="confirmedCellId">0</span></div>

                                <div class="flex justify-center gap-3">
                                    <div
                                        class="bg-green-500/10 border border-green-500/20 px-4 py-2 rounded-xl flex items-center gap-2">
                                        <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                                        <span class="text-green-400 text-xs font-bold uppercase">Live</span>
                                    </div>
                                    <div
                                        class="bg-blue-500/10 border border-blue-500/20 px-4 py-2 rounded-xl flex items-center gap-2">
                                        <span class="text-xl">üåç</span>
                                        <span class="text-blue-400 text-xs font-bold uppercase">Public</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <button onclick="closeClaimModal()"
                            class="w-full mt-8 glow-btn py-5 rounded-2xl font-bold text-lg shadow-[0_0_30px_rgba(139,92,246,0.3)] hover:shadow-[0_0_50px_rgba(139,92,246,0.5)] transition-all transform hover:scale-[1.02]">
                            <span data-en="Go To My Cell üéØ" data-ar="ÿßÿ∞Ÿáÿ® ŸÑÿÆÿßŸÜÿ™Ÿä üéØ">Go To My Cell üéØ</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- View Cell Modal -->
    <div id="viewModal" class="fixed inset-0 modal-overlay z-50 hidden items-center justify-center p-4">
        <div class="bg-[#0f0f24] border border-purple-500/30 max-w-md w-full p-6 relative rounded-3xl shadow-2xl">
            <button onclick="closeViewModal()"
                class="absolute top-4 right-4 w-8 h-8 bg-black/40 hover:bg-white/10 rounded-full flex items-center justify-center text-gray-400 hover:text-white transition border border-white/5">‚úï</button>
            <div id="viewContent"></div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast"
        class="fixed bottom-4 right-4 bg-purple-600 text-white px-6 py-3 rounded-xl shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 z-50">
        <span id="toastMessage">Copied!</span>
    </div>

    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyBiIITaYLK6P4soMF0ThGcGRY3LQ9dQDY4",
            authDomain: "million-logo-page.firebaseapp.com",
            projectId: "million-logo-page",
            storageBucket: "million-logo-page.firebasestorage.app",
            messagingSenderId: "224485393689",
            appId: "1:224485393689:web:85fa9f811071995cbef188",
            measurementId: "G-TR1VSBG8LT"
        };

        let db;
        let storage;
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            storage = firebase.storage();
        } catch (e) {
            console.log("Firebase init:", e);
        }

        // Language System
        let currentLang = 'en';

        function toggleLanguage() {
            currentLang = currentLang === 'en' ? 'ar' : 'en';
            document.documentElement.lang = currentLang;
            document.documentElement.dir = currentLang === 'ar' ? 'rtl' : 'ltr';
            document.body.dir = currentLang === 'ar' ? 'rtl' : 'ltr';

            // Update language button with flag
            document.getElementById('langIcon').textContent = currentLang === 'ar' ? 'üáØüá¥' : 'üá∫üá∏';
            document.getElementById('langText').textContent = currentLang === 'ar' ? 'ÿßŸÑÿπÿ±ÿ®Ÿäÿ©' : 'English';

            document.querySelectorAll('[data-en]').forEach(el => {
                el.textContent = el.getAttribute(`data-${currentLang}`);
            });

            // Update search placeholder
            const searchInput = document.getElementById('searchInput');
            searchInput.placeholder = searchInput.getAttribute(`data-placeholder-${currentLang}`);
        }

        // Welcome Banner
        function showWelcome() {
            if (!localStorage.getItem('welcomeShown')) {
                setTimeout(() => {
                    document.getElementById('welcomeBanner').classList.remove('hidden');
                }, 2000);
            }
        }

        function closeWelcome() {
            document.getElementById('welcomeBanner').classList.add('hidden');
            localStorage.setItem('welcomeShown', 'true');
        }

        // FAQ Toggle
        function toggleFaq(element) {
            const item = element.parentElement;
            item.classList.toggle('open');
        }

        // Canvas Grid System
        let cellsData = {};
        let selectedCellId = null;
        let uploadedImageBase64 = null;

        // Sound Effects
        const sounds = {
            click: new Audio('https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.m4a'), // Soft click
            success: new Audio('https://assets.mixkit.co/active_storage/sfx/1435/1435-preview.m4a'), // Success chime
            hover: new Audio('https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.m4a') // Subtle tick
        };

        // Lower volume
        Object.values(sounds).forEach(s => s.volume = 0.2);

        function playSound(type) {
            try {
                if (sounds[type]) {
                    sounds[type].currentTime = 0;
                    sounds[type].play().catch(e => { }); // Ignore autoplay errors
                }
            } catch (e) { }
        }

        // Canvas variables
        const GRID_COLS = 1000;
        const GRID_ROWS = 1000;
        const TOTAL_CELLS = GRID_COLS * GRID_ROWS; // 1,000,000 cells!
        const BASE_CELL_SIZE = 10;

        let canvas, ctx, miniCanvas, miniCtx;
        let zoom = 1;
        let offsetX = 0, offsetY = 0;
        let isDragging = false;
        let dragStartX, dragStartY;
        let loadedImages = {};
        let hoveredCell = null;

        // Comprehensive Country Dataset
        const countries = [
            { code: 'JO', nameEn: 'Jordan', nameAr: 'ÿßŸÑÿ£ÿ±ÿØŸÜ', flag: 'üáØüá¥' },
            { code: 'SA', nameEn: 'Saudi Arabia', nameAr: 'ÿßŸÑÿ≥ÿπŸàÿØŸäÿ©', flag: 'üá∏üá¶' },
            { code: 'AE', nameEn: 'UAE', nameAr: 'ÿßŸÑÿ•ŸÖÿßÿ±ÿßÿ™', flag: 'üá¶üá™' },
            { code: 'KW', nameEn: 'Kuwait', nameAr: 'ÿßŸÑŸÉŸàŸäÿ™', flag: 'üá∞üáº' },
            { code: 'QA', nameEn: 'Qatar', nameAr: 'ŸÇÿ∑ÿ±', flag: 'üá∂üá¶' },
            { code: 'BH', nameEn: 'Bahrain', nameAr: 'ÿßŸÑÿ®ÿ≠ÿ±ŸäŸÜ', flag: 'üáßüá≠' },
            { code: 'OM', nameEn: 'Oman', nameAr: 'ÿπŸÖÿßŸÜ', flag: 'üá¥üá≤' },
            { code: 'EG', nameEn: 'Egypt', nameAr: 'ŸÖÿµÿ±', flag: 'üá™üá¨' },
            { code: 'PS', nameEn: 'Palestine', nameAr: 'ŸÅŸÑÿ≥ÿ∑ŸäŸÜ', flag: 'üáµüá∏' },
            { code: 'LB', nameEn: 'Lebanon', nameAr: 'ŸÑÿ®ŸÜÿßŸÜ', flag: 'üá±üáß' },
            { code: 'IQ', nameEn: 'Iraq', nameAr: 'ÿßŸÑÿπÿ±ÿßŸÇ', flag: 'üáÆüá∂' },
            { code: 'SY', nameEn: 'Syria', nameAr: 'ÿ≥Ÿàÿ±Ÿäÿß', flag: 'üá∏üáæ' },
            { code: 'LY', nameEn: 'Libya', nameAr: 'ŸÑŸäÿ®Ÿäÿß', flag: 'üá±üáæ' },
            { code: 'SD', nameEn: 'Sudan', nameAr: 'ÿßŸÑÿ≥ŸàÿØÿßŸÜ', flag: 'üá∏üá©' },
            { code: 'MA', nameEn: 'Morocco', nameAr: 'ÿßŸÑŸÖÿ∫ÿ±ÿ®', flag: 'üá≤üá¶' },
            { code: 'DZ', nameEn: 'Algeria', nameAr: 'ÿßŸÑÿ¨ÿ≤ÿßÿ¶ÿ±', flag: 'üá©üáø' },
            { code: 'TN', nameEn: 'Tunisia', nameAr: 'ÿ™ŸàŸÜÿ≥', flag: 'üáπüá≥' },
            { code: 'YE', nameEn: 'Yemen', nameAr: 'ÿßŸÑŸäŸÖŸÜ', flag: 'üáæüá™' },
            { code: 'US', nameEn: 'USA', nameAr: 'ÿ£ŸÖÿ±ŸäŸÉÿß', flag: 'üá∫üá∏' },
            { code: 'GB', nameEn: 'UK', nameAr: 'ÿ®ÿ±Ÿäÿ∑ÿßŸÜŸäÿß', flag: 'üá¨üáß' },
            { code: 'TR', nameEn: 'Turkey', nameAr: 'ÿ™ÿ±ŸÉŸäÿß', flag: 'üáπüá∑' },
            { code: 'DE', nameEn: 'Germany', nameAr: 'ÿ£ŸÑŸÖÿßŸÜŸäÿß', flag: 'üá©üá™' },
            { code: 'FR', nameEn: 'France', nameAr: 'ŸÅÿ±ŸÜÿ≥ÿß', flag: 'üá´üá∑' },
            { code: 'ES', nameEn: 'Spain', nameAr: 'ÿ•ÿ≥ÿ®ÿßŸÜŸäÿß', flag: 'üá™üá∏' },
            { code: 'IT', nameEn: 'Italy', nameAr: 'ÿ•Ÿäÿ∑ÿßŸÑŸäÿß', flag: 'üáÆüáπ' },
            { code: 'CA', nameEn: 'Canada', nameAr: 'ŸÉŸÜÿØÿß', flag: 'üá®üá¶' },
            { code: 'AU', nameEn: 'Australia', nameAr: 'ÿ£ÿ≥ÿ™ÿ±ÿßŸÑŸäÿß', flag: 'üá¶üá∫' },
            { code: 'CN', nameEn: 'China', nameAr: 'ÿßŸÑÿµŸäŸÜ', flag: 'üá®üá≥' },
            { code: 'JP', nameEn: 'Japan', nameAr: 'ÿßŸÑŸäÿßÿ®ÿßŸÜ', flag: 'üáØüáµ' },
            { code: 'KR', nameEn: 'South Korea', nameAr: 'ŸÉŸàÿ±Ÿäÿß ÿßŸÑÿ¨ŸÜŸàÿ®Ÿäÿ©', flag: 'üá∞üá∑' },
            { code: 'OTHER', nameEn: 'Other', nameAr: 'ÿØŸàŸÑÿ© ÿ£ÿÆÿ±Ÿâ', flag: 'üåê' }
            // More can be added as needed
        ];

        function openFlagSelector() {
            document.getElementById('flagSelectorModal').classList.remove('hidden');
            document.getElementById('flagSelectorModal').classList.add('flex');
            renderCountryList(countries);
            document.getElementById('flagSearchInput').value = '';
            document.getElementById('flagSearchInput').focus();
        }

        function closeFlagSelector() {
            document.getElementById('flagSelectorModal').classList.add('hidden');
            document.getElementById('flagSelectorModal').classList.remove('flex');
        }

        function renderCountryList(list) {
            const container = document.getElementById('countryList');
            container.innerHTML = list.map(c => `
                <div onclick="selectCountry('${c.code}')" class="flex items-center gap-3 p-3 hover:bg-white/5 rounded-xl cursor-pointer transition">
                    <span class="text-2xl">${c.flag}</span>
                    <div class="flex-1">
                        <div class="text-white font-bold text-sm">${currentLang === 'ar' ? c.nameAr : c.nameEn}</div>
                        <div class="text-gray-500 text-[10px] uppercase tracking-widest">${c.code}</div>
                    </div>
                </div>
            `).join('');
        }

        function filterCountries() {
            const query = document.getElementById('flagSearchInput').value.toLowerCase().trim();
            const filtered = countries.filter(c =>
                c.nameEn.toLowerCase().includes(query) ||
                c.nameAr.includes(query) ||
                c.code.toLowerCase().includes(query)
            );
            renderCountryList(filtered);
        }

        function selectCountry(code) {
            const country = countries.find(c => c.code === code);
            if (country) {
                document.getElementById('userCountry').value = country.code;
                document.getElementById('currentFlagDisplay').textContent = country.flag;
                document.getElementById('currentCountryName').textContent = currentLang === 'ar' ? country.nameAr : country.nameEn;
                updateLivePreview();
                closeFlagSelector();
            }
        }

        async function loadCells() {
            if (!db) return;

            // 1. Try to load from cache first (Instant load)
            const cachedData = localStorage.getItem('cellsData_v1');
            const cachedTime = localStorage.getItem('cellsData_time');
            const CACHE_DURATION = 5 * 60 * 1000; // 5 minutes

            if (cachedData) {
                try {
                    cellsData = JSON.parse(cachedData);
                    initCanvas(); // Render immediately
                } catch (e) {
                    console.error('Cache parse error', e);
                }
            } else {
                initCanvas(); // Initialize empty canvas first
            }

            // 2. Fetch fresh data from server (Background update)
            try {
                // Check if we need to fetch
                if (cachedTime && (Date.now() - parseInt(cachedTime) < CACHE_DURATION)) {
                    console.log('Using cached data');
                    return;
                }

                const snapshot = await db.collection('cells').get();
                let hasUpdates = false;

                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (JSON.stringify(cellsData[doc.id]) !== JSON.stringify(data)) {
                        cellsData[doc.id] = data;
                        hasUpdates = true;
                    }
                });

                if (hasUpdates || !cachedData) {
                    saveToCache();
                    renderGrid();
                    renderMiniMap();
                    updateStats();
                }

            } catch (error) {
                console.error('Error loading cells:', error);
            }
        }

        function saveToCache() {
            try {
                localStorage.setItem('cellsData_v1', JSON.stringify(cellsData));
                localStorage.setItem('cellsData_time', Date.now().toString());
            } catch (e) {
                console.log('Cache save failed (storage full?)', e);
            }
        }

        function initCanvas() {
            canvas = document.getElementById('gridCanvas');
            ctx = canvas.getContext('2d');
            miniCanvas = document.getElementById('miniMapCanvas');
            miniCtx = miniCanvas.getContext('2d');

            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);

            // Mouse events
            canvas.addEventListener('mousedown', handleMouseDown);
            canvas.addEventListener('mousemove', handleMouseMove);
            canvas.addEventListener('mouseup', handleMouseUp);
            canvas.addEventListener('mouseleave', handleMouseLeave);
            canvas.addEventListener('wheel', handleWheel);
            canvas.addEventListener('click', handleClick);

            // Touch events for mobile
            canvas.addEventListener('touchstart', handleTouchStart, { passive: false });
            canvas.addEventListener('touchmove', handleTouchMove, { passive: false });
            canvas.addEventListener('touchend', handleTouchEnd);

            // Load sold cell images
            // Initial load handled by loadVisibleImages in renderGrid


            // Initial render
            renderGrid();
            renderMiniMap();
            updateStats();
            updateTicker();
        }

        function resizeCanvas() {
            const container = document.getElementById('canvasContainer');
            const width = container.clientWidth;
            const height = Math.min(600, window.innerHeight * 0.6);
            const dpr = window.devicePixelRatio || 1;

            // Set actual size in memory (scaled to account for extra pixel density)
            canvas.width = width * dpr;
            canvas.height = height * dpr;

            // Set visible size in CSS pixels
            canvas.style.width = `${width}px`;
            canvas.style.height = `${height}px`;

            // Normalize coordinate system to use css pixels.
            ctx.scale(dpr, dpr);

            // MiniMap
            miniCanvas.width = 120 * dpr;
            miniCanvas.height = 120 * dpr;
            miniCanvas.style.width = '120px';
            miniCanvas.style.height = '120px';
            miniCtx.scale(dpr, dpr);

            renderGrid();
            renderMiniMap();
        }

        // Preload Removed for Scalability (1M Cells support)


        function renderGrid() {
            if (!ctx) return;

            // ÿ£ÿπŸÑŸâ ÿ¨ŸàÿØÿ© ŸÑŸÑÿµŸàÿ± - Ÿàÿ∂Ÿàÿ≠ ŸÖŸÖÿ™ÿßÿ≤
            ctx.imageSmoothingEnabled = true;
            ctx.imageSmoothingQuality = 'high';

            // ÿ™ÿ≠ÿ≥ŸäŸÜ ÿ•ÿ∂ÿßŸÅŸä ŸÑŸÑŸàÿ∂Ÿàÿ≠
            ctx.globalCompositeOperation = 'source-over';

            const cellSize = BASE_CELL_SIZE * zoom;

            // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸàÿ± ÿßŸÑŸÖÿ±ÿ¶Ÿäÿ© ŸÅŸÇÿ∑ (Lazy Loading)
            loadVisibleImages();

            // Clear canvas
            ctx.fillStyle = '#0f0f1a';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Calculate visible area
            const startCol = Math.max(0, Math.floor(-offsetX / cellSize));
            const startRow = Math.max(0, Math.floor(-offsetY / cellSize));
            const endCol = Math.min(GRID_COLS, Math.ceil((canvas.width - offsetX) / cellSize));
            const endRow = Math.min(GRID_ROWS, Math.ceil((canvas.height - offsetY) / cellSize));

            // Draw cells
            for (let row = startRow; row < endRow; row++) {
                for (let col = startCol; col < endCol; col++) {
                    const cellId = row * GRID_COLS + col;
                    const x = col * cellSize + offsetX;
                    const y = row * cellSize + offsetY;

                    const cellData = cellsData[cellId.toString()];

                    if (cellData && cellData.status === 'active') {
                        // Sold cell
                        if (loadedImages[cellId.toString()]) {
                            ctx.drawImage(loadedImages[cellId.toString()], x, y, cellSize - 1, cellSize - 1);
                        } else {
                            // Gradient for cells without loaded images
                            const gradient = ctx.createLinearGradient(x, y, x + cellSize, y + cellSize);
                            gradient.addColorStop(0, '#8b5cf6');
                            gradient.addColorStop(1, '#ec4899');
                            ctx.fillStyle = gradient;
                            ctx.fillRect(x, y, cellSize - 1, cellSize - 1);
                        }
                    } else {
                        // Available cell
                        ctx.fillStyle = '#1e1e3f';
                        ctx.fillRect(x, y, cellSize - 1, cellSize - 1);

                        // Subtle border
                        ctx.strokeStyle = 'rgba(139, 92, 246, 0.1)';
                        ctx.strokeRect(x, y, cellSize - 1, cellSize - 1);
                    }

                    // Highlight hovered cell - ÿ±ÿ≥ŸÖ ŸÖŸÉÿ®Ÿëÿ± ŸÑŸÑŸàÿ∂Ÿàÿ≠
                    if (hoveredCell === cellId) {
                        // ÿ±ÿ≥ŸÖ ÿ•ÿ∑ÿßÿ± ŸÖŸÖŸäÿ≤
                        ctx.strokeStyle = '#8b5cf6';
                        ctx.lineWidth = 2;
                        ctx.strokeRect(x, y, cellSize - 1, cellSize - 1);
                        ctx.lineWidth = 1;

                        // ÿ•ÿ∞ÿß ŸÉÿßŸÜÿ™ ÿßŸÑÿÆÿßŸÜÿ© ŸÖÿ®ÿßÿπÿ©ÿå ŸÜÿ±ÿ≥ŸÖ ÿµŸàÿ±ÿ© ŸÖŸÉÿ®Ÿëÿ±ÿ© ŸÅŸàŸÇŸáÿß
                        if (cellData && cellData.status === 'active' && loadedImages[cellId.toString()] && zoom < 3) {
                            const enlargedSize = cellSize * 3;
                            const enlargedX = x - cellSize;
                            const enlargedY = y - cellSize;

                            // ÿÆŸÑŸÅŸäÿ©
                            ctx.fillStyle = 'rgba(22, 22, 42, 0.95)';
                            ctx.fillRect(enlargedX - 2, enlargedY - 2, enlargedSize + 4, enlargedSize + 4);

                            // ÿ•ÿ∑ÿßÿ±
                            ctx.strokeStyle = '#8b5cf6';
                            ctx.lineWidth = 2;
                            ctx.strokeRect(enlargedX - 2, enlargedY - 2, enlargedSize + 4, enlargedSize + 4);
                            ctx.lineWidth = 1;

                            // ÿßŸÑÿµŸàÿ±ÿ© ÿßŸÑŸÖŸÉÿ®Ÿëÿ±ÿ©
                            ctx.drawImage(loadedImages[cellId.toString()], enlargedX, enlargedY, enlargedSize, enlargedSize);
                        }
                    }
                }
            }

            // Update zoom display
            document.getElementById('zoomLevel').textContent = Math.round(zoom * 100) + '%';

            // Update viewport indicator on mini map
            updateViewportIndicator();
        }

        function renderMiniMap() {
            if (!miniCtx) return;

            const miniCellSize = 120 / GRID_COLS;

            // Clear
            miniCtx.fillStyle = '#0f0f1a';
            miniCtx.fillRect(0, 0, 120, 120);

            // Draw sold cells as dots
            Object.entries(cellsData).forEach(([id, data]) => {
                if (data.status === 'active') {
                    const cellId = parseInt(id);
                    const col = cellId % GRID_COLS;
                    const row = Math.floor(cellId / GRID_COLS);

                    miniCtx.fillStyle = '#8b5cf6';
                    miniCtx.fillRect(col * miniCellSize, row * miniCellSize, Math.max(1, miniCellSize), Math.max(1, miniCellSize));
                }
            });
        }

        function updateViewportIndicator() {
            const indicator = document.getElementById('viewportIndicator');
            const cellSize = BASE_CELL_SIZE * zoom;
            const gridPixelSize = GRID_COLS * cellSize;

            const viewWidth = (canvas.width / gridPixelSize) * 120;
            const viewHeight = (canvas.height / gridPixelSize) * 120;
            const viewX = (-offsetX / gridPixelSize) * 120;
            const viewY = (-offsetY / gridPixelSize) * 120;

            indicator.style.width = Math.min(120, viewWidth) + 'px';
            indicator.style.height = Math.min(120, viewHeight) + 'px';
            indicator.style.left = Math.max(0, Math.min(120 - viewWidth, viewX)) + 'px';
            indicator.style.top = Math.max(0, Math.min(120 - viewHeight, viewY)) + 'px';
        }

        function updateStats() {
            const soldCount = Object.values(cellsData).filter(c => c.status === 'active').length;
            const availableCount = TOTAL_CELLS - soldCount;

            // Get current values for animation
            const currentSold = parseInt(document.getElementById('soldCount').textContent.replace(/,/g, '')) || 0;
            const currentTotal = parseFloat(document.getElementById('totalInvestment').textContent) || 0;
            const currentAvailable = parseInt(document.getElementById('availableCount').textContent.replace(/,/g, '')) || 1000000;

            const targetTotal = soldCount * 2.00;

            // Animate All 3 Values
            animateValue("soldCount", currentSold, soldCount, 1500, false);
            animateValue("totalInvestment", currentTotal, targetTotal, 1500, true);
            animateValue("availableCount", currentAvailable, availableCount, 1500, false);

            // Update progress bar
            const percent = (soldCount / TOTAL_CELLS) * 100;
            const progressBar = document.getElementById('progressBar');
            const progressPercent = document.getElementById('progressPercent');
            const soldCountSmall = document.getElementById('soldCountSmall');

            if (progressBar) {
                progressBar.style.width = Math.max(percent, 0.01) + '%';
            }
            if (progressPercent) {
                progressPercent.textContent = percent.toFixed(4) + '%';
            }
            if (soldCountSmall) {
                soldCountSmall.textContent = soldCount.toLocaleString();
            }

            // Sync Leaderboard
            updateLeaderboard();
            updateTicker();
        }

        function updateTicker() {
            const tickerContainer = document.getElementById('recentTicker');
            if (!tickerContainer) return;

            // Get last 20 active cells sorted by something (e.g. ID or pseudo-random if no timestamp)
            const activeCells = Object.entries(cellsData)
                .filter(([id, data]) => data.status === 'active')
                .reverse()
                .slice(0, 20);

            if (activeCells.length === 0) return;

            const items = activeCells.map(([id, data]) => {
                const flag = getCountryFlag(data.country);
                return `
                    <div class="ticker-item" onclick="showCellDetails(cellsData['${id}'], ${id})" style="cursor:pointer">
                        <span class="text-white">#${id}</span>
                        <span>${flag} ${data.name || 'Anonymous'}</span>
                        <span class="text-gray-500">‚Ä¢</span>
                    </div>
                `;
            }).join('');

            // Duplicate items for seamless scrolling
            tickerContainer.innerHTML = items + items;
        }

        function animateValue(id, start, end, duration, isCurrency) {
            if (start === end) return;
            const obj = document.getElementById(id);
            const range = end - start;
            let startTime = null;

            function step(timestamp) {
                if (!startTime) startTime = timestamp;
                const progress = Math.min((timestamp - startTime) / duration, 1);
                const current = start + (range * progress);

                if (isCurrency) {
                    obj.textContent = current.toFixed(2);
                } else {
                    obj.textContent = Math.floor(current).toLocaleString();
                }

                if (progress < 1) {
                    window.requestAnimationFrame(step);
                } else {
                    if (isCurrency) obj.textContent = end.toFixed(2);
                    else obj.textContent = end.toLocaleString();
                }
            }
            window.requestAnimationFrame(step);
        }

        // Mouse handlers
        function handleMouseDown(e) {
            isDragging = true;
            dragStartX = e.clientX - offsetX;
            dragStartY = e.clientY - offsetY;
            canvas.style.cursor = 'grabbing';
        }

        function handleMouseMove(e) {
            const rect = canvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;

            const cellSize = BASE_CELL_SIZE * zoom;
            const col = Math.floor((mouseX - offsetX) / cellSize);
            const row = Math.floor((mouseY - offsetY) / cellSize);
            const cellId = row * GRID_COLS + col;

            // Update coordinates display
            if (col >= 0 && col < GRID_COLS && row >= 0 && row < GRID_ROWS) {
                document.getElementById('coordsDisplay').textContent = `X: ${col}, Y: ${row} | Cell: #${cellId.toLocaleString()}`;

                // Update hovered cell
                if (hoveredCell !== cellId) {
                    hoveredCell = cellId;
                    renderGrid();

                    // Show tooltip for sold cells
                    const cellData = cellsData[cellId.toString()];
                    if (cellData && cellData.status === 'active') {
                        showTooltip(e.clientX, e.clientY, cellData, cellId);
                    } else {
                        hideTooltip();
                    }
                }
            }

            if (isDragging) {
                offsetX = e.clientX - dragStartX;
                offsetY = e.clientY - dragStartY;
                constrainOffset();
                renderGrid();
                hideTooltip();
            }
        }

        function handleMouseUp() {
            isDragging = false;
            canvas.style.cursor = 'crosshair';
        }

        function handleMouseLeave() {
            isDragging = false;
            hoveredCell = null;
            hideTooltip();
            renderGrid();
        }

        function handleWheel(e) {
            e.preventDefault();
            const rect = canvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;

            const zoomFactor = e.deltaY > 0 ? 0.9 : 1.1;
            const newZoom = Math.max(0.5, Math.min(10, zoom * zoomFactor));

            // Zoom toward mouse position
            const worldX = (mouseX - offsetX) / zoom;
            const worldY = (mouseY - offsetY) / zoom;

            zoom = newZoom;

            offsetX = mouseX - worldX * zoom;
            offsetY = mouseY - worldY * zoom;

            constrainOffset();
            renderGrid();
            hideTooltip();
        }

        function handleClick(e) {
            if (isDragging) return;

            playSound('click');

            const rect = canvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;

            const cellSize = BASE_CELL_SIZE * zoom;
            const col = Math.floor((mouseX - offsetX) / cellSize);
            const row = Math.floor((mouseY - offsetY) / cellSize);
            const cellId = row * GRID_COLS + col;

            if (col >= 0 && col < GRID_COLS && row >= 0 && row < GRID_ROWS) {
                const cellData = cellsData[cellId.toString()];
                if (cellData && cellData.status === 'active') {
                    showCellDetails(cellData, cellId);
                } else {
                    openClaimModal(cellId);
                }
            }
        }

        // Touch handlers
        let lastTouchDistance = 0;
        let selectMode = false;
        let touchStartTime = 0;
        let touchStartX = 0;
        let touchStartY = 0;

        function toggleSelectMode() {
            selectMode = !selectMode;
            const btn = document.getElementById('selectModeBtn');
            const hint = document.getElementById('mobileHint');

            if (selectMode) {
                btn.classList.add('active');
                btn.innerHTML = '‚úì <span data-en="Selecting..." data-ar="ÿ¨ÿßÿ±Ÿä ÿßŸÑÿßÿÆÿ™Ÿäÿßÿ±...">Selecting...</span>';
                if (hint) hint.textContent = currentLang === 'ar' ? 'üëÜ ÿßŸÑÿ¢ŸÜ ÿßŸÜŸÇÿ± ÿπŸÑŸâ ÿ£Ÿä ÿÆÿßŸÜÿ©' : 'üëÜ Now tap any cell';
                // Auto zoom for easier selection
                if (zoom < 3) {
                    zoom = 4;
                    constrainOffset();
                    renderGrid();
                }
                showToast(currentLang === 'ar' ? 'ÿßŸÜŸÇÿ± ÿπŸÑŸâ ÿßŸÑÿÆÿßŸÜÿ© ÿßŸÑŸÖÿ∑ŸÑŸàÿ®ÿ©' : 'Tap on the cell you want');
            } else {
                btn.classList.remove('active');
                btn.innerHTML = 'üéØ <span data-en="Select" data-ar="ÿßÿÆÿ™Ÿäÿßÿ±">Select</span>';
                if (hint) hint.textContent = currentLang === 'ar' ? 'üëÜ ÿßÿ∂ÿ∫ÿ∑ "ÿßÿÆÿ™Ÿäÿßÿ±" ÿ´ŸÖ ÿßÿÆÿ™ÿ± ÿÆÿßŸÜÿ©' : 'üëÜ Tap "Select" then tap a cell';
            }
        }

        function selectRandomCell() {
            // Find a random available cell
            let attempts = 0;
            let randomId;

            do {
                randomId = Math.floor(Math.random() * TOTAL_CELLS);
                attempts++;
            } while (cellsData[randomId.toString()]?.status === 'active' && attempts < 100);

            // Navigate to the cell
            const col = randomId % GRID_COLS;
            const row = Math.floor(randomId / GRID_COLS);

            zoom = 5;
            const cellSize = BASE_CELL_SIZE * zoom;
            offsetX = canvas.width / 2 - col * cellSize;
            offsetY = canvas.height / 2 - row * cellSize;
            constrainOffset();
            renderGrid();

            // Open claim modal
            setTimeout(() => {
                openClaimModal(randomId);
            }, 300);
        }

        // Browse Random Story - ÿπÿ±ÿ∂ ŸÇÿµÿ© ÿπÿ¥Ÿàÿßÿ¶Ÿäÿ© ŸÖŸÜ ÿßŸÑÿÆÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ®ÿßÿπÿ©
        function browseRandomStory() {
            const soldCells = Object.entries(cellsData).filter(([id, data]) => data.status === 'active');

            if (soldCells.length === 0) {
                showToast(currentLang === 'ar' ? 'ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÇÿµÿµ ÿ®ÿπÿØ! ŸÉŸÜ ÿßŸÑÿ£ŸàŸÑ üöÄ' : 'No stories yet! Be the first üöÄ');
                return;
            }

            // ÿßÿÆÿ™ÿ± ŸÇÿµÿ© ÿπÿ¥Ÿàÿßÿ¶Ÿäÿ©
            const randomIndex = Math.floor(Math.random() * soldCells.length);
            const [cellId, cellData] = soldCells[randomIndex];

            // ÿßŸÜÿ™ŸÇŸÑ ŸÑŸÑÿÆÿßŸÜÿ© ÿπŸÑŸâ ÿßŸÑÿ¥ÿ®ŸÉÿ©
            const col = parseInt(cellId) % GRID_COLS;
            const row = Math.floor(parseInt(cellId) / GRID_COLS);

            zoom = 5;
            const cellSize = BASE_CELL_SIZE * zoom;
            offsetX = canvas.width / 2 - col * cellSize;
            offsetY = canvas.height / 2 - row * cellSize;
            constrainOffset();
            renderGrid();

            // ÿßÿπÿ±ÿ∂ ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÇÿµÿ©
            setTimeout(() => {
                showCellDetails(cellData, cellId);
            }, 300);
        }

        function handleTouchStart(e) {
            e.preventDefault();
            touchStartTime = Date.now();

            if (e.touches.length === 1) {
                touchStartX = e.touches[0].clientX;
                touchStartY = e.touches[0].clientY;
                isDragging = true;
                dragStartX = e.touches[0].clientX - offsetX;
                dragStartY = e.touches[0].clientY - offsetY;
            } else if (e.touches.length === 2) {
                isDragging = false;
                lastTouchDistance = Math.hypot(
                    e.touches[0].clientX - e.touches[1].clientX,
                    e.touches[0].clientY - e.touches[1].clientY
                );
            }
        }

        function handleTouchMove(e) {
            e.preventDefault();
            if (e.touches.length === 1 && isDragging) {
                const moveX = Math.abs(e.touches[0].clientX - touchStartX);
                const moveY = Math.abs(e.touches[0].clientY - touchStartY);

                // Only pan if moved more than 10px (not a tap)
                if (moveX > 10 || moveY > 10) {
                    offsetX = e.touches[0].clientX - dragStartX;
                    offsetY = e.touches[0].clientY - dragStartY;
                    constrainOffset();
                    renderGrid();
                }
            } else if (e.touches.length === 2) {
                const distance = Math.hypot(
                    e.touches[0].clientX - e.touches[1].clientX,
                    e.touches[0].clientY - e.touches[1].clientY
                );
                const zoomFactor = distance / lastTouchDistance;
                zoom = Math.max(0.5, Math.min(10, zoom * zoomFactor));
                lastTouchDistance = distance;
                constrainOffset();
                renderGrid();
            }
        }

        function handleTouchEnd(e) {
            const touchDuration = Date.now() - touchStartTime;
            const touch = e.changedTouches[0];
            const moveX = Math.abs(touch.clientX - touchStartX);
            const moveY = Math.abs(touch.clientY - touchStartY);

            // Detect tap (short touch, minimal movement)
            if (touchDuration < 300 && moveX < 15 && moveY < 15) {
                const rect = canvas.getBoundingClientRect();
                const touchX = touch.clientX - rect.left;
                const touchY = touch.clientY - rect.top;

                const cellSize = BASE_CELL_SIZE * zoom;
                const col = Math.floor((touchX - offsetX) / cellSize);
                const row = Math.floor((touchY - offsetY) / cellSize);
                const cellId = row * GRID_COLS + col;

                if (col >= 0 && col < GRID_COLS && row >= 0 && row < GRID_ROWS) {
                    const cellData = cellsData[cellId.toString()];

                    if (cellData && cellData.status === 'active') {
                        // If in select mode or second tap, show details
                        if (selectMode || lastTappedCell === cellId) {
                            showCellDetails(cellData, cellId);
                            lastTappedCell = null;
                        } else {
                            // First tap - show tooltip
                            showMobileTooltip(touch.clientX, touch.clientY, cellData, cellId);
                            lastTappedCell = cellId;

                            // Auto-hide tooltip after 3 seconds
                            setTimeout(() => {
                                hideTooltip();
                                if (lastTappedCell === cellId) lastTappedCell = null;
                            }, 3000);
                        }
                    } else {
                        // Available cell - open claim modal
                        if (selectMode || window.innerWidth < 768) {
                            openClaimModal(cellId);
                        }
                    }

                    // Turn off select mode after selection
                    if (selectMode) {
                        toggleSelectMode();
                    }
                }
            }

            isDragging = false;
        }

        function getCountryFlag(code) {
            const country = countries.find(c => c.code === code);
            return country ? country.flag : 'üåê';
        }

        let lastTappedCell = null;

        function showMobileTooltip(x, y, data, cellId) {
            const tooltip = document.getElementById('cellTooltip');
            const likes = data.likes || 0;
            const comments = data.comments || [];
            const dateStr = data.specialDate ? new Date(data.specialDate).toLocaleDateString() : '';
            const storyPreview = data.story ? (data.story.length > 50 ? data.story.substring(0, 50) + '...' : data.story) : '';
            const imgSrc = data.imageUrl || data.imageBase64;

            tooltip.innerHTML = `
                ${imgSrc ? `<img src="${imgSrc}" alt="${data.name}">` : '<div style="width:80px;height:80px;margin:0 auto 0.75rem;border-radius:0.75rem;background:linear-gradient(135deg,#8b5cf6,#ec4899);display:flex;align-items:center;justify-content:center;font-size:2rem;">üéØ</div>'}
                <div class="tooltip-name">${data.name || 'Anonymous'}</div>
                <div class="tooltip-cell-id">Cell #${cellId.toLocaleString()}</div>
                ${dateStr ? `<div class="tooltip-date">üìÖ ${dateStr}</div>` : ''}
                ${storyPreview ? `<div class="tooltip-story">"${storyPreview}"</div>` : ''}
                <div class="tooltip-stats">
                    <div class="tooltip-stat likes">‚ù§Ô∏è ${likes}</div>
                    <div class="tooltip-stat comments">üí¨ ${comments.length}</div>
                </div>
                <div class="tooltip-hint" style="color:#a78bfa;font-weight:600;">${currentLang === 'ar' ? 'üëÜ ÿßÿ∂ÿ∫ÿ∑ ŸÖÿ±ÿ© ÿ´ÿßŸÜŸäÿ© ŸÑŸÑÿ™ŸÅÿßÿµŸäŸÑ' : 'üëÜ Tap again for details'}</div>
            `;

            // Center tooltip on mobile
            const tooltipWidth = 240;
            let left = x - tooltipWidth / 2;
            let top = y - 220;

            // Keep on screen
            if (left < 10) left = 10;
            if (left + tooltipWidth > window.innerWidth - 10) left = window.innerWidth - tooltipWidth - 10;
            if (top < 10) top = y + 30;

            tooltip.style.left = left + 'px';
            tooltip.style.top = top + 'px';
            tooltip.classList.remove('hidden');
        }

        function constrainOffset() {
            const cellSize = BASE_CELL_SIZE * zoom;
            const gridWidth = GRID_COLS * cellSize;
            const gridHeight = GRID_ROWS * cellSize;

            offsetX = Math.max(canvas.width - gridWidth, Math.min(0, offsetX));
            offsetY = Math.max(canvas.height - gridHeight, Math.min(0, offsetY));
        }

        // Zoom controls
        function zoomIn() {
            zoom = Math.min(10, zoom * 1.3);
            constrainOffset();
            renderGrid();
        }

        function zoomOut() {
            zoom = Math.max(0.5, zoom * 0.7);
            constrainOffset();
            renderGrid();
        }

        function resetView() {
            zoom = 1;
            offsetX = 0;
            offsetY = 0;
            renderGrid();
        }

        // Tooltip
        function showTooltip(x, y, data, cellId) {
            const tooltip = document.getElementById('cellTooltip');
            const likes = data.likes || 0;
            const comments = data.comments || [];
            const dateStr = data.specialDate ? new Date(data.specialDate).toLocaleDateString() : '';
            const storyPreview = data.story ? (data.story.length > 60 ? data.story.substring(0, 60) + '...' : data.story) : '';
            const imgSrc = data.imageUrl || data.imageBase64;

            tooltip.innerHTML = `
                ${imgSrc ? `<img src="${imgSrc}" alt="${data.name}">` : '<div style="width:80px;height:80px;margin:0 auto 0.75rem;border-radius:0.75rem;background:linear-gradient(135deg,#8b5cf6,#ec4899);display:flex;align-items:center;justify-content:center;font-size:2rem;">üéØ</div>'}
                <div class="tooltip-name">${data.name || 'Anonymous'}</div>
                <div class="tooltip-cell-id">Cell #${cellId.toLocaleString()}</div>
                ${dateStr ? `<div class="tooltip-date">üìÖ ${dateStr}</div>` : ''}
                ${storyPreview ? `<div class="tooltip-story">"${storyPreview}"</div>` : ''}
                <div class="tooltip-stats">
                    <div class="tooltip-stat likes">‚ù§Ô∏è ${likes}</div>
                    <div class="tooltip-stat comments">üí¨ ${comments.length}</div>
                </div>
                <div class="tooltip-hint">${currentLang === 'ar' ? 'ÿßÿ∂ÿ∫ÿ∑ ŸÑŸÖÿ¥ÿßŸáÿØÿ© ÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ' : 'Click to view details'}</div>
            `;

            // Position tooltip smartly
            const rect = document.getElementById('canvasContainer').getBoundingClientRect();
            let left = x + 15;
            let top = y + 15;

            // Adjust if tooltip goes off screen
            if (left + 260 > window.innerWidth) {
                left = x - 270;
            }
            if (top + 300 > window.innerHeight) {
                top = y - 200;
            }

            tooltip.style.left = left + 'px';
            tooltip.style.top = top + 'px';
            tooltip.classList.remove('hidden');
        }

        function hideTooltip() {
            document.getElementById('cellTooltip').classList.add('hidden');
        }

        // Search Functionality
        function searchCells(query) {
            const searchResults = document.getElementById('searchResults');
            const resultsList = document.getElementById('searchResultsList');
            const clearBtn = document.getElementById('clearSearchBtn');

            if (!query.trim()) {
                searchResults.classList.add('hidden');
                clearBtn.classList.add('hidden');
                return;
            }

            clearBtn.classList.remove('hidden');

            const results = Object.entries(cellsData)
                .filter(([id, data]) =>
                    data.name && data.name.toLowerCase().includes(query.toLowerCase()) && data.status === 'active'
                )
                .slice(0, 8);

            if (results.length === 0) {
                searchResults.classList.add('hidden');
                return;
            }

            searchResults.classList.remove('hidden');
            resultsList.innerHTML = results.map(([id, data]) => `
                <div class="bg-white/5 p-3 rounded-lg cursor-pointer hover:bg-white/10 transition" onclick="showCellDetails(cellsData['${id}'], ${id}); clearSearch();">
                    <div class="flex items-center gap-3">
                        ${data.imageBase64
                    ? `<img src="${data.imageBase64}" class="w-10 h-10 rounded-lg object-cover">`
                    : `<div class="w-10 h-10 rounded-lg bg-gradient-to-br from-purple-500 to-pink-500"></div>`
                }
                        <div class="overflow-hidden">
                            <div class="font-semibold text-white text-sm truncate">${data.name}</div>
                            <div class="text-gray-500 text-xs">Cell #${id}</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function clearSearch() {
            document.getElementById('searchInput').value = '';
            document.getElementById('searchResults').classList.add('hidden');
            document.getElementById('clearSearchBtn').classList.add('hidden');
        }

        // Modal Functions
        function openClaimModal(cellId) {
            selectedCellId = cellId;
            document.getElementById('selectedCellId').textContent = cellId;
            document.getElementById('previewCellIdDisplay').textContent = cellId; // Update preview ID
            document.getElementById('claimModal').classList.remove('hidden');
            document.getElementById('claimModal').classList.add('flex');
            document.body.style.overflow = 'hidden';
            showStep(1);
            resetForm();
            updateLivePreview(); // Initialize preview
        }

        function closeClaimModal() {
            document.getElementById('claimModal').classList.add('hidden');
            document.getElementById('claimModal').classList.remove('flex');
            document.body.style.overflow = '';
        }

        let paypalButtonsRendered = false;

        function showStep(step) {
            document.querySelectorAll('.step-content').forEach(s => s.classList.add('hidden'));
            document.getElementById(`step${step}`).classList.remove('hidden');

            for (let i = 1; i <= 3; i++) {
                const dot = document.getElementById(`stepDot${i}`);
                dot.className = `w-2.5 h-2.5 rounded-full ${i <= step ? 'bg-purple-500' : 'bg-gray-600'}`;
            }

            const icons = { 1: '‚ú®', 2: 'üí≥', 3: 'üéâ' };
            const titlesEn = { 1: 'Share Your Story', 2: 'Choose Payment', 3: 'Success!' };
            const titlesAr = { 1: 'ÿ¥ÿßÿ±ŸÉ ŸÇÿµÿ™ŸÉ', 2: 'ÿßÿÆÿ™ÿ± ÿßŸÑÿØŸÅÿπ', 3: 'ÿ™ŸÖ ÿ®ŸÜÿ¨ÿßÿ≠!' };

            document.getElementById('stepIcon').textContent = icons[step];
            const titleEl = document.getElementById('stepTitle');
            titleEl.setAttribute('data-en', titlesEn[step]);
            titleEl.setAttribute('data-ar', titlesAr[step]);
            titleEl.textContent = currentLang === 'ar' ? titlesAr[step] : titlesEn[step];


        }




        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // Auto-Activation System (Gumroad Webhook)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        let activationPollingInterval = null;
        let pollingAttempts = 0;
        const MAX_POLLING_ATTEMPTS = 60; // 60 attempts √ó 2 seconds = 2 minutes

        /**
         * Start auto-polling after payment button click
         * Ÿäÿ®ÿØÿ£ ÿßŸÑŸÅÿ≠ÿµ ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä ÿ®ÿπÿØ ÿßŸÑÿ∂ÿ∫ÿ∑ ÿπŸÑŸâ ÿ≤ÿ± ÿßŸÑÿØŸÅÿπ
         */
        async function startAutoActivationPolling() {
            // Save cell data before payment
            await savePendingCellData();

            // Wait 3 seconds for Gumroad overlay to open
            setTimeout(() => {
                showWaitingScreen();
                startPolling();
            }, 3000);
        }

        /**
         * Save cell data in localStorage before redirect (FREE METHOD)
         * ÿ≠ŸÅÿ∏ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿÆÿßŸÜÿ© ŸÅŸä localStorage ŸÇÿ®ŸÑ ÿßŸÑÿ™ÿ≠ŸàŸäŸÑ
         */
        async function savePendingCellData() {
            try {
                const cellData = {
                    cellId: selectedCellId,
                    name: document.getElementById('userName').value.trim(),
                    specialDate: document.getElementById('specialDate').value,
                    story: document.getElementById('userStory').value.trim(),
                    imageBase64: uploadedImageBase64,
                    timestamp: Date.now()
                };

                // Save to localStorage (FREE - doesn't need Blaze Plan)
                localStorage.setItem(`pending_cell_${selectedCellId}`, JSON.stringify(cellData));
                console.log(`üìù Cell #${selectedCellId} saved to localStorage`);
            } catch (error) {
                console.error('Error saving pending cell:', error);
            }
        }


        /**
         * Show waiting screen in Step 2
         * ÿπÿ±ÿ∂ ÿ¥ÿßÿ¥ÿ© ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±
         */
        function showWaitingScreen() {
            // Update Step 2 content to show waiting state
            const step2 = document.getElementById('step2');
            const originalContent = step2.innerHTML;

            step2.innerHTML = `
                <div class="text-center py-12">
                    <div class="relative mb-8">
                        <div class="inline-block p-6 rounded-full bg-gradient-to-br from-purple-500/20 to-pink-500/20 border border-purple-500/30 backdrop-blur-md animate-pulse">
                            <span class="text-6xl">‚è≥</span>
                        </div>
                    </div>
                    
                    <h3 class="text-3xl font-black text-white mb-3" data-en="Verifying Payment..." data-ar="ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿØŸÅÿπ...">
                        ${currentLang === 'ar' ? 'ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿØŸÅÿπ...' : 'Verifying Payment...'}
                    </h3>
                    <p class="text-gray-400 mb-8" data-en="This usually takes 5-15 seconds" data-ar="ÿπÿßÿØÿ© Ÿäÿ£ÿÆÿ∞ 5-15 ÿ´ÿßŸÜŸäÿ©">
                        ${currentLang === 'ar' ? 'ÿπÿßÿØÿ© Ÿäÿ£ÿÆÿ∞ 5-15 ÿ´ÿßŸÜŸäÿ©' : 'This usually takes 5-15 seconds'}
                    </p>
                    
                    <div class="bg-white/5 rounded-2xl p-6 max-w-md mx-auto">
                        <div class="flex items-center gap-3 mb-4">
                            <span class="animate-spin text-2xl">‚Üª</span>
                            <span class="text-sm text-gray-300" id="pollingStatus">
                                ${currentLang === 'ar' ? 'ŸÅÿ≠ÿµ ÿ±ŸÇŸÖ 1...' : 'Check #1...'}
                            </span>
                        </div>
                        <div class="w-full bg-white/10 rounded-full h-2">
                            <div id="pollingProgress" class="bg-gradient-to-r from-purple-500 to-pink-500 h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <button onclick="cancelPolling()" class="mt-6 text-xs text-gray-500 hover:text-white transition">
                        ${currentLang === 'ar' ? '‚Üê ÿ•ŸÑÿ∫ÿßÿ°' : '‚Üê Cancel'}
                    </button>
                </div>
            `;
        }

        /**
         * Start polling to check if cell is activated
         * ÿ®ÿØÿ° ÿßŸÑŸÅÿ≠ÿµ ÿßŸÑÿØŸàÿ±Ÿä ŸÑŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿÆÿßŸÜÿ©
         */
        function startPolling() {
            pollingAttempts = 0;

            activationPollingInterval = setInterval(async () => {
                pollingAttempts++;

                // Update UI
                const statusEl = document.getElementById('pollingStatus');
                const progressEl = document.getElementById('pollingProgress');
                if (statusEl) {
                    statusEl.textContent = currentLang === 'ar'
                        ? `ŸÅÿ≠ÿµ ÿ±ŸÇŸÖ ${pollingAttempts}...`
                        : `Check #${pollingAttempts}...`;
                }
                if (progressEl) {
                    const progress = (pollingAttempts / MAX_POLLING_ATTEMPTS) * 100;
                    progressEl.style.width = progress + '%';
                }

                // Check if cell is activated
                const isActivated = await checkCellActivation();

                if (isActivated) {
                    clearInterval(activationPollingInterval);
                    await uploadImageAndFinalize();
                    showSuccessStep();
                } else if (pollingAttempts >= MAX_POLLING_ATTEMPTS) {
                    clearInterval(activationPollingInterval);
                    showPollingTimeout();
                }
            }, 2000); // Check every 2 seconds
        }

        /**
         * Check if the cell has been activated by webhook
         * ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿÆÿßŸÜÿ© ÿ®Ÿàÿßÿ≥ÿ∑ÿ© ÿßŸÑŸÄ webhook
         */
        async function checkCellActivation() {
            if (!db) return false;

            try {
                const docRef = db.collection('cells').doc(selectedCellId.toString());
                const doc = await docRef.get();

                if (doc.exists) {
                    const data = doc.data();
                    return data.status === 'active' && data.paid === true;
                }
                return false;
            } catch (error) {
                console.error('Error checking activation:', error);
                return false;
            }
        }

        /**
         * Upload image to Firebase Storage after activation
         * ÿ±ŸÅÿπ ÿßŸÑÿµŸàÿ±ÿ© ÿ•ŸÑŸâ Firebase Storage ÿ®ÿπÿØ ÿßŸÑÿ™ŸÅÿπŸäŸÑ
         */
        async function uploadImageAndFinalize() {
            if (!uploadedImageBase64 || !storage) return;

            try {
                const storageRef = storage.ref();
                const imageRef = storageRef.child(`cells/${selectedCellId}_${Date.now()}.jpg`);
                const snapshot = await imageRef.putString(uploadedImageBase64, 'data_url');
                const imageUrl = await snapshot.ref.getDownloadURL();

                // Update cell with image URL
                await db.collection('cells').doc(selectedCellId.toString()).update({
                    imageUrl: imageUrl,
                    imageBase64: imageUrl // For compatibility
                });

                // Update local state
                cellsData[selectedCellId.toString()].imageUrl = imageUrl;
                cellsData[selectedCellId.toString()].imageBase64 = imageUrl;
                loadImageAsync(selectedCellId.toString(), imageUrl);

                console.log('‚úÖ Image uploaded successfully');
            } catch (error) {
                console.error('Error uploading image:', error);
            }
        }

        /**
         * Show success step after activation
         * ÿπÿ±ÿ∂ ÿ¥ÿßÿ¥ÿ© ÿßŸÑŸÜÿ¨ÿßÿ≠ ÿ®ÿπÿØ ÿßŸÑÿ™ŸÅÿπŸäŸÑ
         */
        function showSuccessStep() {
            playSound('success');
            showStep(3);
            document.getElementById('confirmedCellId').textContent = selectedCellId;
            launchConfetti();
            loadRecentActivity();
        }

        /**
         * Show timeout message if polling failed
         * ÿπÿ±ÿ∂ ÿ±ÿ≥ÿßŸÑÿ© ÿßŸÜÿ™Ÿáÿßÿ° ÿßŸÑŸÖŸáŸÑÿ©
         */
        function showPollingTimeout() {
            const step2 = document.getElementById('step2');
            step2.innerHTML = `
                <div class="text-center py-8">
                    <div class="text-6xl mb-4">‚ö†Ô∏è</div>
                    <h3 class="text-2xl font-bold text-white mb-3">
                        ${currentLang === 'ar' ? 'ŸÑŸÖ ŸÜÿ™ŸÖŸÉŸÜ ŸÖŸÜ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã' : 'Auto-verification timeout'}
                    </h3>
                    <p class="text-gray-400 mb-6 max-w-md mx-auto">
                        ${currentLang === 'ar'
                    ? 'ÿßŸÑÿØŸÅÿπ ŸÇÿØ Ÿäÿ≥ÿ™ÿ∫ÿ±ŸÇ ÿ®ÿ∂ÿπ ÿØŸÇÿßÿ¶ŸÇ. Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ®ÿ±ŸäÿØŸÉ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä ÿ£Ÿà ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÑÿßÿ≠ŸÇÿßŸã.'
                    : 'Payment may take a few minutes to process. Please check your email or try again later.'}
                    </p>
                    <button onclick="closeClaimModal()" class="glow-btn px-8 py-3 rounded-xl">
                        ${currentLang === 'ar' ? 'ÿ≠ÿ≥ŸÜÿßŸã' : 'OK'}
                    </button>
                </div>
            `;
        }

        /**
         * Cancel polling
         * ÿ•ŸÑÿ∫ÿßÿ° ÿßŸÑŸÅÿ≠ÿµ
         */
        function cancelPolling() {
            if (activationPollingInterval) {
                clearInterval(activationPollingInterval);
            }
            showStep(2);
        }

        /**
         * Check URL for license key and auto-activate (ZERO FRICTION METHOD)
         */
        async function checkURLForActivation() {
            const urlParams = new URLSearchParams(window.location.search);
            const licenseKey = urlParams.get('key') || urlParams.get('license_key');
            const cellId = urlParams.get('cell') || urlParams.get('cell_id');

            if (licenseKey && cellId) {
                console.log('üîë License key detected in URL, auto-activating...');

                // Get pending cell data from localStorage
                const pendingData = localStorage.getItem(`pending_cell_${cellId}`);

                if (pendingData) {
                    const cellData = JSON.parse(pendingData);
                    selectedCellId = parseInt(cellId);
                    uploadedImageBase64 = cellData.imageBase64;

                    // Immediately show the modal in loading state
                    openClaimModal(selectedCellId);
                    const step2 = document.getElementById('step2');
                    step2.innerHTML = `
                        <div class="text-center py-12">
                            <div class="loading-spinner mb-6"></div>
                            <h3 class="text-2xl font-bold text-white mb-2">${currentLang === 'ar' ? 'ÿ¨ÿßÿ±Ÿä ÿ™ŸÅÿπŸäŸÑ ÿÆÿßŸÜÿ™ŸÉ...' : 'Activating your cell...'}</h3>
                            <p class="text-gray-400">${currentLang === 'ar' ? 'ŸÑÿ≠ÿ∏ÿßÿ™ Ÿàÿ≥ŸäŸÉÿ™ŸÖŸÑ ÿ•ÿ±ÿ´ŸÉ ÿßŸÑÿ±ŸÇŸÖŸä' : 'Almost there, your digital legacy is being placed...'}</p>
                        </div>
                    `;

                    // Activate automatically
                    await activateCellWithKey(cellData, licenseKey);

                    // Clean up
                    localStorage.removeItem(`pending_cell_${cellId}`);

                    // Remove parameters from URL
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
            }
        }

        /**
         * Activate cell with license key (used by redirect method)
         * ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿÆÿßŸÜÿ© ÿ®ÿßŸÑŸÖŸÅÿ™ÿßÿ≠
         */
        async function activateCellWithKey(cellData, licenseKey) {
            try {
                // Upload image to Firebase Storage
                let imageUrl = null;
                if (uploadedImageBase64 && storage) {
                    const storageRef = storage.ref();
                    const imageRef = storageRef.child(`cells/${selectedCellId}_${Date.now()}.jpg`);
                    const snapshot = await imageRef.putString(uploadedImageBase64, 'data_url');
                    imageUrl = await snapshot.ref.getDownloadURL();
                }

                // Save to Firestore as ACTIVE
                const activeCellData = {
                    cellId: selectedCellId,
                    name: cellData.name,
                    specialDate: cellData.specialDate,
                    story: cellData.story,
                    imageUrl: imageUrl,
                    imageBase64: imageUrl,
                    status: 'active',
                    paid: true,
                    paymentMethod: 'gumroad',
                    licenseKey: licenseKey,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    likes: 0,
                    comments: []
                };

                if (db) {
                    await db.collection('cells').doc(selectedCellId.toString()).set(activeCellData);
                }

                // Update local state
                cellsData[selectedCellId.toString()] = activeCellData;
                if (imageUrl) loadImageAsync(selectedCellId.toString(), imageUrl);
                requestRender();
                loadRecentActivity();

                // Show success modal
                openClaimModal(selectedCellId);
                showStep(3);
                document.getElementById('confirmedCellId').textContent = selectedCellId;
                launchConfetti();
                playSound('success');

                console.log('‚úÖ Cell activated successfully via redirect!');
            } catch (error) {
                console.error('‚ùå Error activating cell:', error);
                showToast(currentLang === 'ar' ? 'ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ™ŸÅÿπŸäŸÑ' : 'Activation error');
            }
        }


        function resetForm() {
            document.getElementById('userName').value = '';
            document.getElementById('specialDate').value = '';
            document.getElementById('userStory').value = '';
            document.getElementById('uploadPlaceholder').classList.remove('hidden');
            document.getElementById('uploadPreview').classList.add('hidden');
            document.getElementById('uploadZone').classList.remove('has-image');
            uploadedImageBase64 = null;
            updateLivePreview(); // Clear preview
        }

        function goToPayment() {
            const name = document.getElementById('userName').value.trim();
            const story = document.getElementById('userStory').value.trim();
            const date = document.getElementById('specialDate').value;

            if (!name) { showToast(currentLang === 'ar' ? 'ÿ£ÿØÿÆŸÑ ÿßÿ≥ŸÖŸÉ' : 'Please enter your name'); return; }
            if (!story) { showToast(currentLang === 'ar' ? 'ÿ¥ÿßÿ±ŸÉ ŸÇÿµÿ™ŸÉ' : 'Please share your story'); return; }
            if (!uploadedImageBase64) { showToast(currentLang === 'ar' ? 'ÿßÿ±ŸÅÿπ ÿµŸàÿ±ÿ©' : 'Please upload an image'); return; }

            // Save data for auto-activation
            savePendingCellData(name, story, date);

            showStep(2);
            renderPayPalButtons();
        }

        let paypalRendered = false;
        function renderPayPalButtons() {
            if (paypalRendered) return;

            paypal.Buttons({
                createOrder: function (data, actions) {
                    return actions.order.create({
                        purchase_units: [{
                            amount: {
                                value: '2.00'
                            },
                            description: `Million Dollar Cell #${selectedCellId}`
                        }],
                        application_context: {
                            shipping_preference: 'NO_SHIPPING',
                            user_action: 'PAY_NOW'
                        }
                    });
                },
                onApprove: function (data, actions) {
                    return actions.order.capture().then(async function (details) {
                        console.log('‚úÖ PayPal Payment Successful:', details);

                        // Show loading state
                        const step2 = document.getElementById('step2');
                        if (step2) {
                            step2.innerHTML = `
                                <div class="text-center py-12">
                                    <div class="loading-spinner mb-6"></div>
                                    <h3 class="text-2xl font-bold text-white mb-2">${currentLang === 'ar' ? 'ÿ™ŸÖ ÿßŸÑÿØŸÅÿπ! ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ŸÅÿπŸäŸÑ...' : 'Paid! Activating your cell...'}</h3>
                                    <p class="text-gray-400">${currentLang === 'ar' ? 'ÿ´ŸàÿßŸÜŸä Ÿàÿ™ÿ∏Ÿáÿ± ÿÆÿßŸÜÿ™ŸÉ ŸÑŸÑÿ¨ŸÖŸäÿπ' : 'Just a few seconds and you will be live...'}</p>
                                </div>
                            `;
                        }

                        // Activation
                        const pendingData = localStorage.getItem(`pending_cell_${selectedCellId}`);
                        if (pendingData) {
                            const cellData = JSON.parse(pendingData);
                            await activateCellWithKey(cellData, details.id);
                            localStorage.removeItem(`pending_cell_${selectedCellId}`);
                        }
                    });
                },
                onError: function (err) {
                    console.error('‚ùå PayPal Error:', err);
                    showToast(currentLang === 'ar' ? 'ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿØŸÅÿπ' : 'Payment error occurred');
                }
            }).render('#paypal-button-container');

            paypalRendered = true;
        }

        /**
         * Save pending cell data to localStorage for auto-activation
         */
        function savePendingCellData(name, story, date) {
            const pendingData = {
                name: name,
                story: story,
                specialDate: date || '',
                imageBase64: uploadedImageBase64,
                timestamp: Date.now()
            };
            localStorage.setItem(`pending_cell_${selectedCellId}`, JSON.stringify(pendingData));
            console.log(`üíæ Saved pending data for cell ${selectedCellId}`);
        }



        /**
         * Manual Fallback Activation Logic
         */
        async function activateWithFallbackKey() {
            const key = document.getElementById('fallbackKeyInput').value.trim();
            if (!key) {
                showToast(currentLang === 'ar' ? 'Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿßŸÑŸÖŸÅÿ™ÿßÿ≠' : 'Please enter the key');
                return;
            }

            const pendingData = localStorage.getItem(`pending_cell_${selectedCellId}`);
            if (!pendingData) {
                showToast(currentLang === 'ar' ? 'ŸÅÿ™ÿ±ÿ© ÿßŸÑÿ¨ŸÑÿ≥ÿ© ÿßŸÜÿ™Ÿáÿ™ÿå ÿßŸÖŸÑÿ£ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖÿ¨ÿØÿØÿßŸã' : 'Session expired, please fill the data again');
                showStep(1);
                return;
            }

            const cellData = JSON.parse(pendingData);

            // Show loading
            showToast(currentLang === 'ar' ? '‚è≥ ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÇŸÇ...' : '‚è≥ Verifying...');

            await activateCellWithKey(cellData, key);

            // Cleanup
            localStorage.removeItem(`pending_cell_${selectedCellId}`);
        }

        function goBack() { showStep(1); }

        // Image Upload
        function handleImageUpload(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];

                if (file.size > 500 * 1024) {
                    compressImage(file);
                } else {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        uploadedImageBase64 = e.target.result;
                        showImagePreview(uploadedImageBase64);
                    };
                    reader.readAsDataURL(file);
                }
            }
        }

        function compressImage(file) {
            const reader = new FileReader();
            reader.onload = function (e) {
                const img = new Image();
                img.onload = function () {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;

                    // ÿ≠ÿ¨ŸÖ ŸÉÿ®Ÿäÿ± ŸÑŸàÿ∂Ÿàÿ≠ ŸÖŸÖÿ™ÿßÿ≤ (ŸÑŸÉŸÜ ŸÑŸäÿ≥ ŸÉÿ®Ÿäÿ± ÿ¨ÿØÿßŸã ŸÑŸÑÿ≠ŸÅÿßÿ∏ ÿπŸÑŸâ ÿßŸÑÿ≥ÿ±ÿπÿ©)
                    const maxDim = 800;
                    if (width > height && width > maxDim) {
                        height = (height * maxDim) / width;
                        width = maxDim;
                    } else if (height > maxDim) {
                        width = (width * maxDim) / height;
                        height = maxDim;
                    }

                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');

                    // ÿ£ÿπŸÑŸâ ÿ¨ŸàÿØÿ© ÿ±ÿ≥ŸÖ
                    ctx.imageSmoothingEnabled = true;
                    ctx.imageSmoothingQuality = 'high';
                    ctx.drawImage(img, 0, 0, width, height);

                    // ÿ¨ŸàÿØÿ© ÿπÿßŸÑŸäÿ© ÿ¨ÿØÿßŸã 95%
                    uploadedImageBase64 = canvas.toDataURL('image/jpeg', 0.95);
                    showImagePreview(uploadedImageBase64);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // ŸÜÿ∏ÿßŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸàÿ± ÿßŸÑÿ∞ŸÉŸä - Lazy Loading ŸÖÿπ ÿ£ÿπŸÑŸâ ÿ¨ŸàÿØÿ©
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        const MAX_CACHED_IMAGES = 200; // ÿ≠ÿØ ÿ£ŸÇÿµŸâ ŸÑŸÑÿµŸàÿ± ÿßŸÑŸÖÿ≠ŸÖŸÑÿ©
        const imageLoadQueue = []; // ŸÇÿßÿ¶ŸÖÿ© ÿßŸÜÿ™ÿ∏ÿßÿ± ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ
        let isLoadingImages = false;

        // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸàÿ± ÿßŸÑŸÖÿ±ÿ¶Ÿäÿ© ŸÅŸÇÿ∑
        function loadVisibleImages() {
            if (!ctx) return;

            const cellSize = BASE_CELL_SIZE * zoom;
            const startCol = Math.max(0, Math.floor(-offsetX / cellSize));
            const startRow = Math.max(0, Math.floor(-offsetY / cellSize));
            const endCol = Math.min(GRID_COLS, Math.ceil((canvas.width - offsetX) / cellSize));
            const endRow = Math.min(GRID_ROWS, Math.ceil((canvas.height - offsetY) / cellSize));

            // ÿ¨ŸÖÿπ ÿßŸÑÿÆÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ±ÿ¶Ÿäÿ© ÿßŸÑÿ™Ÿä ÿ™ÿ≠ÿ™ÿßÿ¨ ÿ™ÿ≠ŸÖŸäŸÑ
            const visibleCells = [];
            for (let row = startRow; row < endRow; row++) {
                for (let col = startCol; col < endCol; col++) {
                    const cellId = row * GRID_COLS + col;
                    const cellData = cellsData[cellId.toString()];

                    if (cellData && cellData.status === 'active' && cellData.imageBase64 && !loadedImages[cellId.toString()]) {
                        visibleCells.push({ id: cellId.toString(), data: cellData });
                    }
                }
            }

            // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸàÿ± ÿßŸÑŸÖÿ±ÿ¶Ÿäÿ©
            visibleCells.forEach(cell => {
                if (!loadedImages[cell.id]) {
                    loadImageAsync(cell.id, cell.data.imageBase64);
                }
            });

            // ÿ™ŸÜÿ∏ŸäŸÅ ÿßŸÑÿµŸàÿ± ÿ∫Ÿäÿ± ÿßŸÑŸÖÿ±ÿ¶Ÿäÿ© ÿ•ÿ∞ÿß ÿ™ÿ¨ÿßŸàÿ≤ŸÜÿß ÿßŸÑÿ≠ÿØ
            cleanupOldImages(startCol, startRow, endCol, endRow);
        }

        function loadImageAsync(id, base64) {
            const img = new Image();
            img.onload = () => {
                loadedImages[id] = img;
                renderGrid(); // ÿ•ÿπÿßÿØÿ© ÿßŸÑÿ±ÿ≥ŸÖ ŸÑÿ•ÿ∏Ÿáÿßÿ± ÿßŸÑÿµŸàÿ±ÿ©
            };
            img.src = base64;
        }

        function cleanupOldImages(startCol, startRow, endCol, endRow) {
            const keys = Object.keys(loadedImages);
            if (keys.length <= MAX_CACHED_IMAGES) return;

            // ÿ≠ÿ∞ŸÅ ÿßŸÑÿµŸàÿ± ÿßŸÑÿ®ÿπŸäÿØÿ© ÿπŸÜ ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© ÿßŸÑŸÖÿ±ÿ¶Ÿäÿ©
            const toRemove = [];
            keys.forEach(id => {
                const cellId = parseInt(id);
                const col = cellId % GRID_COLS;
                const row = Math.floor(cellId / GRID_COLS);

                // ÿ•ÿ∞ÿß ŸÉÿßŸÜÿ™ ÿßŸÑÿµŸàÿ±ÿ© ÿ®ÿπŸäÿØÿ© ÿ¨ÿØÿßŸã
                if (col < startCol - 50 || col > endCol + 50 || row < startRow - 50 || row > endRow + 50) {
                    toRemove.push(id);
                }
            });

            // ÿ≠ÿ∞ŸÅ ÿ£ŸÇÿØŸÖ ÿßŸÑÿµŸàÿ±
            toRemove.slice(0, toRemove.length - MAX_CACHED_IMAGES + 50).forEach(id => {
                delete loadedImages[id];
            });
        }

        function showImagePreview(src) {
            document.getElementById('previewImage').src = src;
            document.getElementById('uploadPlaceholder').classList.add('hidden');
            document.getElementById('uploadPreview').classList.remove('hidden');
            document.getElementById('uploadZone').classList.add('has-image');

            // Update Live Preview Cell (Mini-Grid)
            const previewCell = document.getElementById('previewGridCell');
            previewCell.innerHTML = `<img src="${src}" class="w-full h-full object-cover">`;
            previewCell.classList.add('border-white', 'shadow-[0_0_20px_rgba(139,92,246,0.8)]');
            previewCell.classList.remove('animate-pulse'); // Stop pulsing once image is there

            // Update Tooltip Avatar (High-Fidelity)
            const avatar = document.getElementById('previewTooltipAvatar');
            avatar.style.background = `url(${src})`;
            avatar.style.backgroundSize = 'cover';
            avatar.style.backgroundPosition = 'center';
            avatar.innerHTML = ''; // Remove sparkle icon

            showToast(currentLang === 'ar' ? 'ÿ™ŸÖ ÿ±ŸÅÿπ ÿßŸÑÿµŸàÿ±ÿ© ‚úì' : 'Image uploaded! ‚úì');
            updateLivePreview();
        }

        function updateLivePreview() {
            const name = document.getElementById('userName').value.trim();
            const story = document.getElementById('userStory').value.trim();
            const date = document.getElementById('specialDate').value;

            // Name & Flag
            const previewName = document.getElementById('previewNameText');
            const previewFlag = document.getElementById('previewFlag');
            const countrySelect = document.getElementById('userCountry');
            const selectedOption = countrySelect.options[countrySelect.selectedIndex];
            const flag = selectedOption.text.split(' ')[0];

            previewName.textContent = name || (currentLang === 'ar' ? 'ÿßÿ≥ŸÖŸÉ ŸáŸÜÿß' : 'Your Name');
            previewFlag.textContent = flag;

            // Date
            const previewDate = document.getElementById('previewDate');
            const previewDateWrapper = document.getElementById('previewDateWrapper');
            if (date) {
                previewDate.textContent = date;
                previewDateWrapper.classList.remove('hidden');
                previewDateWrapper.classList.add('flex');
            } else {
                previewDateWrapper.classList.add('hidden');
                previewDateWrapper.classList.remove('flex');
            }

            // Story
            const previewStory = document.getElementById('previewStory');
            const defaultText = currentLang === 'ar' ? 'ŸÇÿµÿ™ŸÉ ÿßŸÑÿ±ÿßÿ¶ÿπÿ© ÿ≥ÿ™ÿ∏Ÿáÿ± ŸáŸÜÿß...' : 'Your amazing story will appear here...';
            previewStory.textContent = story ? `"${story}"` : `"${defaultText}"`;

            // Avatar fallback if no image
            if (!uploadedImageBase64) {
                const avatar = document.getElementById('previewTooltipAvatar');
                avatar.style.background = 'linear-gradient(135deg, #8b5cf6, #ec4899)';
                avatar.innerHTML = '<span class="text-2xl opacity-50">‚ú®</span>';

                const previewCell = document.getElementById('previewGridCell');
                previewCell.innerHTML = '<span class="text-white text-xs font-bold">üéØ</span>';
                previewCell.classList.add('animate-pulse');
            }
        }

        // Attach listeners for live preview
        document.addEventListener('DOMContentLoaded', () => {
            const inputs = ['userName', 'userStory', 'specialDate', 'userCountry'];
            inputs.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.addEventListener('input', updateLivePreview);
                    if (id === 'userCountry') el.addEventListener('change', updateLivePreview);
                }
            });
        });

        // Submit Cell
        async function submitCell(payerName = null, paymentMethod = 'manual', licenseKey = null) {
            const btn = document.getElementById('submitBtn');
            if (btn) btn.innerHTML = '<span class="animate-spin text-xl">‚Üª</span>';

            // If manual, validate receipt
            if (paymentMethod === 'manual' && !uploadedImageBase64) {
                const receiptInput = document.getElementById('receiptUpload');
                if (receiptInput && receiptInput.files.length === 0) {
                    showToast(currentLang === 'ar' ? 'Ÿäÿ±ÿ¨Ÿâ ÿ•ÿ±ŸÅÿßŸÇ ÿµŸàÿ±ÿ© ÿßŸÑÿ™ÿ≠ŸàŸäŸÑ' : 'Please upload transfer receipt');
                    if (btn) btn.innerHTML = '<span data-en="Confirm ‚ö°" data-ar="ÿ™ÿ£ŸÉŸäÿØ ‚ö°">Confirm ‚ö°</span>';
                    return;
                }
            }

            try {
                let imageUrl = null;

                // Upload CELL Image (from Step 1)
                if (uploadedImageBase64 && storage) {
                    const storageRef = storage.ref();
                    const imageRef = storageRef.child(`cells/${selectedCellId}_${Date.now()}.jpg`);
                    const snapshot = await imageRef.putString(uploadedImageBase64, 'data_url');
                    imageUrl = await snapshot.ref.getDownloadURL();
                }

                const isActive = (paymentMethod === 'gumroad' || paymentMethod === 'paypal');

                const cellData = {
                    cellId: selectedCellId,
                    name: document.getElementById('userName').value.trim(),
                    country: document.getElementById('userCountry').value,
                    specialDate: document.getElementById('specialDate').value,
                    story: document.getElementById('userStory').value.trim(),
                    imageUrl: imageUrl,
                    imageBase64: imageUrl,
                    status: isActive ? 'active' : 'pending',
                    paid: isActive,
                    paymentMethod: paymentMethod,
                    payerName: payerName,
                    licenseKey: licenseKey, // Store key for audit
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    likes: 0,
                    comments: []
                };

                if (db) {
                    await db.collection('cells').doc(selectedCellId.toString()).set(cellData);
                }

                // Update local state ONLY if active
                if (isActive) {
                    cellsData[selectedCellId.toString()] = cellData;
                    if (imageUrl) loadImageAsync(selectedCellId.toString(), imageUrl);
                    requestRender();
                    loadRecentActivity();
                }

                // Show Success
                showStep(3);
                document.getElementById('confirmedCellId').textContent = selectedCellId;

                // Fire confetti
                launchConfetti();

            } catch (error) {
                console.error('Error submitting:', error);
                showToast('Error saving data');
            }

            if (btn) btn.innerHTML = '<span data-en="Confirm ‚ö°" data-ar="ÿ™ÿ£ŸÉŸäÿØ ‚ö°">Confirm ‚ö°</span>';
        }
        // View Cell Details with Likes & Comments
        function showCellDetails(data, cellId) {
            const content = document.getElementById('viewContent');
            const dateStr = data.specialDate ? new Date(data.specialDate).toLocaleDateString() : '';
            const shareUrl = `${window.location.origin}${window.location.pathname}?cell=${cellId}`;
            const shareText = currentLang === 'ar'
                ? `ÿ¥ÿßŸáÿØ ÿÆÿßŸÜÿ™Ÿä ŸÅŸä ÿßŸÑÿµŸÅÿ≠ÿ© ÿßŸÑŸÖŸÑŸäŸàŸÜ ÿ¥ÿπÿßÿ±! üéØ`
                : `Check out my cell on The Million Logo Page! üéØ`;

            // Get likes and comments from data or initialize
            const likes = data.likes || 0;
            const comments = data.comments || [];
            const hasLiked = localStorage.getItem(`liked_${cellId}`) === 'true';

            const imgSrc = data.imageUrl || data.imageBase64;

            content.innerHTML = `
                <div class="text-center">
                    ${imgSrc
                    ? `<img src="${imgSrc}" class="w-28 h-28 rounded-2xl mx-auto object-cover border-2 border-purple-500/30 shadow-lg">`
                    : `<div class="w-28 h-28 rounded-2xl mx-auto bg-gradient-to-br from-purple-500/20 to-pink-500/20 flex items-center justify-center text-4xl">üéØ</div>`
                }
                    
                    <h3 class="text-xl font-bold mt-4 text-white">${getCountryFlag(data.country)} ${data.name || 'Anonymous'}</h3>
                    <p class="text-gray-500 text-xs mt-1">Cell #${cellId.toLocaleString()}</p>
                </div>
                
                <div class="mt-5 space-y-3">
                    ${dateStr ? `
                    <div class="bg-white/5 p-3 rounded-xl">
                        <div class="text-xs text-gray-500 mb-1">üìÖ ${currentLang === 'ar' ? 'ÿ™ÿßÿ±ŸäÿÆ ŸÖŸáŸÖ' : 'Special Date'}</div>
                        <div class="text-white text-sm">${dateStr}</div>
                    </div>
                    ` : ''}
                    
                    ${data.story ? `
                    <div class="bg-white/5 p-3 rounded-xl">
                        <div class="text-xs text-gray-500 mb-1">üìñ ${currentLang === 'ar' ? 'ÿßŸÑŸÇÿµÿ©' : 'Story'}</div>
                        <div class="text-gray-300 text-sm leading-relaxed">${data.story}</div>
                    </div>
                    ` : ''}
                </div>
                
                <!-- Likes & Comments Section -->
                <div class="mt-5 pt-4 border-t border-white/10">
                    <!-- Like Button & Stats -->
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-4">
                            <button onclick="toggleLike('${cellId}')" id="likeBtn_${cellId}" 
                                class="flex items-center gap-2 ${hasLiked ? 'bg-pink-500/30 text-pink-400' : 'bg-white/5 text-gray-400 hover:text-pink-400 hover:bg-pink-500/20'} px-4 py-2 rounded-full transition-all transform hover:scale-105 active:scale-95">
                                <span class="text-lg">${hasLiked ? '‚ù§Ô∏è' : 'ü§ç'}</span>
                                <span id="likeCount_${cellId}" class="font-semibold">${likes}</span>
                            </button>
                            <div class="flex items-center gap-2 text-gray-400">
                                <span>üí¨</span>
                                <span id="commentCount_${cellId}">${comments.length}</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Comments List -->
                    <div class="bg-white/5 rounded-xl p-3 mb-3 max-h-32 overflow-y-auto" id="commentsList_${cellId}">
                        ${comments.length > 0 ? comments.map(c => `
                            <div class="flex items-start gap-2 mb-2 last:mb-0">
                                <div class="w-6 h-6 rounded-full bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center text-xs flex-shrink-0">${c.name ? c.name.charAt(0).toUpperCase() : 'üë§'}</div>
                                <div class="flex-1 min-w-0">
                                    <span class="text-purple-400 text-xs font-semibold">${c.name || 'ÿ≤ÿßÿ¶ÿ±'}</span>
                                    <p class="text-gray-300 text-sm break-words">${c.text}</p>
                                </div>
                            </div>
                        `).join('') : `
                            <p class="text-gray-500 text-xs text-center py-2">${currentLang === 'ar' ? 'ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ™ÿπŸÑŸäŸÇÿßÿ™ ÿ®ÿπÿØ. ŸÉŸÜ ÿ£ŸàŸÑ ŸÖŸÜ ŸäÿπŸÑŸëŸÇ!' : 'No comments yet. Be the first!'}</p>
                        `}
                    </div>
                    
                    <!-- Add Comment -->
                    <div class="flex gap-2">
                        <input type="text" id="commentName_${cellId}" 
                            class="w-20 bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-xs text-white placeholder-gray-500 focus:border-purple-500 outline-none"
                            placeholder="${currentLang === 'ar' ? 'ÿßÿ≥ŸÖŸÉ' : 'Name'}">
                        <input type="text" id="commentText_${cellId}" 
                            class="flex-1 bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-sm text-white placeholder-gray-500 focus:border-purple-500 outline-none"
                            placeholder="${currentLang === 'ar' ? 'ÿßŸÉÿ™ÿ® ÿ™ÿπŸÑŸäŸÇÿßŸã...' : 'Write a comment...'}"
                            onkeypress="if(event.key==='Enter')addComment('${cellId}')">
                        <button onclick="addComment('${cellId}')" 
                            class="bg-gradient-to-r from-purple-500 to-pink-500 hover:opacity-90 px-4 py-2 rounded-lg text-sm font-semibold transition transform hover:scale-105 active:scale-95">
                            ${currentLang === 'ar' ? '‚Üµ' : '‚Üµ'}
                        </button>
                    </div>
                </div>
                
                <!-- Share Buttons -->
                <div class="mt-4 pt-4 border-t border-white/10">
                    <p class="text-xs text-gray-500 text-center mb-3">${currentLang === 'ar' ? 'ÿ¥ÿßÿ±ŸÉ Ÿáÿ∞Ÿá ÿßŸÑÿÆÿßŸÜÿ©' : 'Share this cell'}</p>
                    <div class="flex justify-center gap-2">
                        <a href="https://wa.me/?text=${encodeURIComponent(shareText + ' ' + shareUrl)}" target="_blank" 
                           class="flex items-center gap-1 bg-green-500/20 hover:bg-green-500/30 text-green-400 px-3 py-2 rounded-lg transition text-xs">
                            üì± WhatsApp
                        </a>
                        <a href="https://twitter.com/intent/tweet?text=${encodeURIComponent(shareText)}&url=${encodeURIComponent(shareUrl)}" target="_blank"
                           class="flex items-center gap-1 bg-blue-500/20 hover:bg-blue-500/30 text-blue-400 px-3 py-2 rounded-lg transition text-xs">
                            üê¶ Twitter
                        </a>
                        <button onclick="copyText('${shareUrl}')" 
                           class="flex items-center gap-1 bg-purple-500/20 hover:bg-purple-500/30 text-purple-400 px-3 py-2 rounded-lg transition text-xs">
                            üîó ${currentLang === 'ar' ? 'ŸÜÿ≥ÿÆ' : 'Copy'}
                        </button>
                    </div>
                </div>
            `;

            document.getElementById('viewModal').classList.remove('hidden');
            document.getElementById('viewModal').classList.add('flex');
        }

        // Toggle Like
        async function toggleLike(cellId) {
            const hasLiked = localStorage.getItem(`liked_${cellId}`) === 'true';
            const likeBtn = document.getElementById(`likeBtn_${cellId}`);
            const likeCount = document.getElementById(`likeCount_${cellId}`);

            let currentLikes = parseInt(likeCount.textContent) || 0;

            if (hasLiked) {
                // Unlike
                currentLikes = Math.max(0, currentLikes - 1);
                localStorage.removeItem(`liked_${cellId}`);
                likeBtn.classList.remove('bg-pink-500/30', 'text-pink-400');
                likeBtn.classList.add('bg-white/5', 'text-gray-400');
                likeBtn.querySelector('span').textContent = 'ü§ç';
            } else {
                // Like
                currentLikes += 1;
                localStorage.setItem(`liked_${cellId}`, 'true');
                likeBtn.classList.add('bg-pink-500/30', 'text-pink-400');
                likeBtn.classList.remove('bg-white/5', 'text-gray-400');
                likeBtn.querySelector('span').textContent = '‚ù§Ô∏è';

                // Animation
                likeBtn.style.transform = 'scale(1.2)';
                setTimeout(() => likeBtn.style.transform = 'scale(1)', 150);
            }

            likeCount.textContent = currentLikes;

            // Update in Firebase
            if (db && cellsData[cellId]) {
                try {
                    await db.collection('cells').doc(cellId).update({ likes: currentLikes });
                    cellsData[cellId].likes = currentLikes;
                } catch (e) { console.log('Like update:', e); }
            }
        }

        // Add Comment
        async function addComment(cellId) {
            const nameInput = document.getElementById(`commentName_${cellId}`);
            const textInput = document.getElementById(`commentText_${cellId}`);
            const commentsList = document.getElementById(`commentsList_${cellId}`);
            const commentCount = document.getElementById(`commentCount_${cellId}`);

            const name = nameInput.value.trim() || (currentLang === 'ar' ? 'ÿ≤ÿßÿ¶ÿ±' : 'Guest');
            const text = textInput.value.trim();

            if (!text) {
                showToast(currentLang === 'ar' ? 'ÿßŸÉÿ™ÿ® ÿ™ÿπŸÑŸäŸÇÿßŸã' : 'Write a comment');
                return;
            }

            // Create comment
            const comment = { name, text, date: new Date().toISOString() };

            // Update UI
            const commentHtml = `
                <div class="flex items-start gap-2 mb-2">
                    <div class="w-6 h-6 rounded-full bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center text-xs flex-shrink-0">${name.charAt(0).toUpperCase()}</div>
                    <div class="flex-1 min-w-0">
                        <span class="text-purple-400 text-xs font-semibold">${name}</span>
                        <p class="text-gray-300 text-sm break-words">${text}</p>
                    </div>
                </div>
            `;

            // Remove "no comments" message if exists
            if (commentsList.querySelector('.text-center')) {
                commentsList.innerHTML = '';
            }

            commentsList.insertAdjacentHTML('beforeend', commentHtml);
            commentsList.scrollTop = commentsList.scrollHeight;

            // Update count
            const currentCount = parseInt(commentCount.textContent) || 0;
            commentCount.textContent = currentCount + 1;

            // Clear input
            textInput.value = '';

            // Update in Firebase
            if (db && cellsData[cellId]) {
                try {
                    const comments = cellsData[cellId].comments || [];
                    comments.push(comment);
                    await db.collection('cells').doc(cellId).update({ comments });
                    cellsData[cellId].comments = comments;
                } catch (e) { console.log('Comment update:', e); }
            }

            showToast(currentLang === 'ar' ? 'ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿ™ÿπŸÑŸäŸÇŸÉ ‚ù§Ô∏è' : 'Comment added ‚ù§Ô∏è');
        }

        function closeViewModal() {
            document.getElementById('viewModal').classList.add('hidden');
            document.getElementById('viewModal').classList.remove('flex');
        }

        // Utilities
        function copyText(text) {
            navigator.clipboard.writeText(text);
            showToast(currentLang === 'ar' ? 'ÿ™ŸÖ ÿßŸÑŸÜÿ≥ÿÆ ‚úì' : 'Copied! ‚úì');
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            document.getElementById('toastMessage').textContent = message;
            toast.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => toast.classList.add('translate-y-20', 'opacity-0'), 3000);
        }

        // Close modals
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') { closeClaimModal(); closeViewModal(); }
        });

        document.getElementById('claimModal').addEventListener('click', (e) => {
            if (e.target.id === 'claimModal') closeClaimModal();
        });

        document.getElementById('viewModal').addEventListener('click', (e) => {
            if (e.target.id === 'viewModal') closeViewModal();
        });

        // Load Founding Wall
        function updateLeaderboard() {
            const leaderboardList = document.getElementById('leaderboardList');
            if (!leaderboardList) return;

            const counts = {};
            Object.values(cellsData).forEach(cell => {
                if (cell.status === 'active' && cell.country) {
                    counts[cell.country] = (counts[cell.country] || 0) + 1;
                }
            });

            const sorted = Object.entries(counts).sort((a, b) => b[1] - a[1]).slice(0, 5);

            if (sorted.length === 0) {
                leaderboardList.innerHTML = `<div class="text-gray-500 text-center py-4">${currentLang === 'ar' ? 'ÿ®ÿßŸÜÿ™ÿ∏ÿßÿ± ÿßŸÑŸÖÿ®ÿØÿπŸäŸÜ ÿßŸÑÿ£Ÿàÿßÿ¶ŸÑ...' : 'Waiting for the first pioneers...'}</div>`;
                return;
            }

            leaderboardList.innerHTML = sorted.map(([code, count], index) => {
                const flag = getCountryFlag(code);
                const percent = Math.min(100, (count / 10) * 100); // Scale for visual
                return `
                    <div class="space-y-2">
                        <div class="flex justify-between items-center text-sm">
                            <div class="flex items-center gap-3">
                                <span class="w-6 h-6 rounded-full bg-white/5 flex items-center justify-center text-[10px] font-bold text-purple-400 border border-white/10">${index + 1}</span>
                                <span class="text-white font-bold">${flag} ${code}</span>
                            </div>
                            <span class="text-purple-400 font-black">${count} Cells</span>
                        </div>
                        <div class="h-1.5 bg-white/5 rounded-full overflow-hidden">
                            <div class="h-full bg-gradient-to-r from-purple-500 to-pink-500 rounded-full" style="width: ${percent}%"></div>
                        </div>
                    </div>
                `;
            }).join('');
        }


        async function loadFoundingWall() {
            if (!db) return;

            try {
                const snapshot = await db.collection('cells')
                    .where('status', '==', 'active')
                    .orderBy('createdAt', 'asc')
                    .limit(3)
                    .get();

                const founders = [];
                snapshot.forEach(doc => founders.push({ id: doc.id, ...doc.data() }));

                updateFoundingWall(founders);
            } catch (error) {
                console.log('Founding wall will update when first cells are added');
            }
        }

        function updateFoundingWall(founders) {
            for (let i = 0; i < 3; i++) {
                const founder = founders[i];
                const num = i + 1;

                if (founder) {
                    const imgEl = document.getElementById(`founder${num}Image`);
                    const imgSrc = founder.imageUrl || founder.imageBase64;
                    if (imgSrc) {
                        imgEl.innerHTML = `<img src="${imgSrc}" class="w-full h-full rounded-full object-cover">`;
                    } else {
                        imgEl.textContent = founder.name.charAt(0).toUpperCase();
                    }

                    document.getElementById(`founder${num}Name`).textContent = founder.name;
                    document.getElementById(`founder${num}Story`).textContent = founder.story || '';
                }
            }
        }

        // Recent Activity Ticker
        async function loadRecentActivity() {
            if (!db) return;

            try {
                const snapshot = await db.collection('cells')
                    .where('status', '==', 'active')
                    .orderBy('createdAt', 'desc')
                    .limit(10)
                    .get();

                const activities = [];
                snapshot.forEach(doc => activities.push({ id: doc.id, ...doc.data() }));

                if (activities.length > 0) {
                    const ticker = document.getElementById('activityTicker');
                    const content = document.getElementById('tickerContent');
                    ticker.classList.remove('hidden');

                    const itemsHtml = activities.map(item => `
                        <div class="flex items-center gap-2 text-sm text-gray-300 px-4 border-r border-white/10 last:border-0">
                            <span class="text-lg">‚ö°</span>
                            <span class="font-bold text-white">${item.name}</span>
                            <span class="text-gray-400 text-xs">${currentLang === 'ar' ? 'ÿßÿ¥ÿ™ÿ±Ÿâ ÿßŸÑÿÆÿßŸÜÿ©' : 'claimed cell'} #${item.id}</span>
                            <span class="text-xs text-gray-500">(${new Date(item.createdAt?.toDate()).toLocaleDateString()})</span>
                        </div>
                    `).join('');

                    // Duplicate for seamless loop
                    content.innerHTML = itemsHtml + itemsHtml + itemsHtml;
                }
            } catch (e) {
                console.log('Ticker init:', e);
            }
        }

        // Simple Particle Effect
        function initParticles() {
            const canvas = document.createElement('canvas');
            canvas.style.position = 'fixed';
            canvas.style.top = '0';
            canvas.style.left = '0';
            canvas.style.width = '100%';
            canvas.style.height = '100%';
            canvas.style.pointerEvents = 'none';
            canvas.style.zIndex = '-1';
            document.body.prepend(canvas);

            const ctx = canvas.getContext('2d');
            let width, height;
            let particles = [];

            function resize() {
                width = canvas.width = window.innerWidth;
                height = canvas.height = window.innerHeight;
            }

            class Particle {
                constructor() {
                    this.reset();
                }

                reset() {
                    this.x = Math.random() * width;
                    this.y = Math.random() * height;
                    this.vx = (Math.random() - 0.5) * 0.5;
                    this.vy = (Math.random() - 0.5) * 0.5;
                    this.size = Math.random() * 2;
                    this.alpha = Math.random() * 0.5;
                }

                update() {
                    this.x += this.vx;
                    this.y += this.vy;

                    if (this.x < 0 || this.x > width) this.vx *= -1;
                    if (this.y < 0 || this.y > height) this.vy *= -1;
                }

                draw() {
                    ctx.fillStyle = `rgba(139, 92, 246, ${this.alpha})`;
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                    ctx.fill();
                }
            }

            function init() {
                particles = [];
                for (let i = 0; i < 50; i++) {
                    particles.push(new Particle());
                }
            }

            function animate() {
                ctx.clearRect(0, 0, width, height);
                particles.forEach(p => {
                    p.update();
                    p.draw();
                });
                requestAnimationFrame(animate);
            }

            window.addEventListener('resize', resize);
            resize();
            init();
            animate();
        }

        // Initialize (Add initParticles)
        loadCells();
        loadFoundingWall();
        loadRecentActivity();
        showWelcome();
        initParticles();

        // Check URL for auto-activation (redirect method)
        checkURLForActivation();
    </script>
</body>

</html>